<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Falco Cash</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #0d9488; /* Teal-600 */
            --light-gray: #f3f4f6;
            --medium-gray: #9ca3af;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--light-gray);
        }
        .sidebar {
            transition: transform 0.3s ease-in-out;
            z-index: 40;
        }
        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            color: #4b5563;
            border-radius: 0.5rem;
            transition: all 0.2s;
            font-weight: 500;
        }
        .sidebar-link:hover, .sidebar-link.active {
            background-color: var(--primary-color);
            color: white;
        }
        .sidebar-link i {
            font-size: 1.5rem;
            margin-right: 0.75rem;
        }
        .stat-card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* --- Custom Modal Styles --- */
        .custom-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }
        .custom-modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .custom-modal {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            width: 95%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.95);
            transition: transform 0.2s;
            position: relative; /* For close button positioning */
        }
        .custom-modal-overlay.visible .custom-modal {
            transform: scale(1);
        }
        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }
        .close-btn:hover {
            color: #374151;
        }
        .submenu {
            display: none;
        }
        .submenu.active {
            display: block;
        }
        .tab-button {
            padding: 0.75rem 1.5rem;
            background-color: #e5e7eb; /* Gray-200 */
            border: none;
            border-radius: 0.5rem 0.5rem 0 0;
            cursor: pointer;
            font-weight: 500;
            margin-right: 0.25rem;
        }
        .tab-button.active {
            background-color: white;
            border-bottom: 3px solid var(--primary-color);
        }
        .color-picker {
            width: 50px;
            height: 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .drag-handle {
            cursor: move;
        }
        .dragging {
            opacity: 0.5;
        }
        .form-input {
             width: 100%;
             padding: 0.75rem;
             border: 1px solid #d1d5db;
             border-radius: 0.5rem;
        }
        .sidebar nav {
            /* Updated height to accommodate new links */
            height: calc(100% - 150px);
            overflow-y: auto;
            padding-bottom: 1rem;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="login-page" class="flex items-center justify-center min-h-screen bg-gray-200">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
            <div class="text-center">
                <i class="ph-bold ph-shield-check text-5xl text-teal-600"></i>
                <h1 class="text-3xl font-bold mt-2 text-gray-800">Admin Panel</h1>
                <p class="text-gray-500">Please enter the admin password</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-password" class="font-medium text-gray-600">Admin Password</label>
                    <input type="password" id="login-password" class="w-full mt-1 p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500" required placeholder="••••••••">
                </div>
                <button type="submit" class="w-full py-3 mt-4 font-semibold text-white bg-teal-600 rounded-lg hover:bg-teal-700 transition">Sign In</button>
            </form>
            <div class="text-center text-sm text-gray-500">
                <p>Default password: <code>3681206</code></p>
            </div>
        </div>
    </div>

    <div id="admin-panel" class="hidden">
        <aside id="sidebar" class="sidebar fixed top-0 left-0 w-64 h-screen bg-white shadow-lg p-4 transform -translate-x-full md:translate-x-0">
            <div class="text-center mb-6">
                 <i class="ph-bold ph-bank text-4xl text-teal-600 inline-block"></i>
                 <h2 class="text-2xl font-bold text-gray-800">Falco Cash</h2>
                 <p class="text-sm text-gray-500">Admin</p>
            </div>
            <nav class="space-y-2">
                <a href="#" class="sidebar-link active" data-page="dashboard-page"><i class="ph-bold ph-gauge"></i>Dashboard</a>
                <a href="#" class="sidebar-link" data-page="users-page"><i class="ph-bold ph-users"></i>Users</a>
                <a href="#" class="sidebar-link" data-page="deposits-page"><i class="ph-bold ph-arrow-down-left"></i>Deposits</a>
                <a href="#" class="sidebar-link" data-page="withdrawals-page"><i class="ph-bold ph-arrow-up-right"></i>Withdrawals</a>
                <a href="#" class="sidebar-link" data-page="membership-applications-page"><i class="ph-bold ph-user-switch"></i>Manual Activations</a>
                <a href="#" class="sidebar-link" data-page="plans-page"><i class="ph-bold ph-package"></i>Membership Plans</a>
                <a href="#" class="sidebar-link" data-page="tasks-page"><i class="ph-bold ph-check-circle"></i>Task Management</a>
                <a href="#" class="sidebar-link" data-page="support-links-page"><i class="ph-bold ph-link"></i>Support Links</a>
                <a href="#" class="sidebar-link" data-page="appearance-page"><i class="ph-bold ph-palette"></i>Appearance</a>
                <a href="#" class="sidebar-link" data-page="slider-control-page"><i class="ph-bold ph-slideshow"></i>Slider Control</a>
                <a href="#" class="sidebar-link" data-page="notifications-page"><i class="ph-bold ph-bell"></i>Notifications</a>
                <a href="#" class="sidebar-link" data-page="analytics-page"><i class="ph-bold ph-chart-line"></i>Analytics</a>
                <!-- NEW REFERRALS LINK -->
                <a href="#" class="sidebar-link" data-page="referrals-page"><i class="ph-bold ph-users-four"></i>Referrals</a>
                <a href="#" class="sidebar-link" data-page="settings-page"><i class="ph-bold ph-gear"></i>Settings</a>
            </nav>
            <div class="absolute bottom-4 left-4 right-4">
                 <button id="logout-btn" class="w-full flex items-center justify-center gap-2 py-2.5 font-semibold text-red-600 bg-red-100 rounded-lg hover:bg-red-200 transition">
                     <i class="ph-bold ph-sign-out"></i> Logout
                 </button>
            </div>
        </aside>

        <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-30 md:hidden hidden"></div>

        <main class="ml-0 md:ml-64 p-4 md:p-8">
            
            <div class="md:hidden flex justify-between items-center bg-white p-4 shadow-md mb-6 rounded-lg">
                <button id="menu-toggle-btn" class="text-2xl text-teal-600">
                    <i class="ph-bold ph-list"></i>
                </button>
                <h2 class="text-xl font-bold text-gray-800">Falco Cash</h2>
                <i class="ph-bold ph-bank text-2xl text-teal-600"></i>
            </div>
            
            <div id="dashboard-page" class="page active">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Dashboard</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="stat-card">
                        <i class="ph-bold ph-users text-4xl text-blue-500 mb-3"></i>
                        <p class="text-lg text-gray-500">Total Users</p>
                        <p id="total-users-stat" class="text-4xl font-bold">0</p>
                    </div>
                    <div class="stat-card">
                        <i class="ph-bold ph-clock-countdown text-4xl text-yellow-500 mb-3"></i>
                        <p class="text-lg text-gray-500">Pending Deposits</p>
                        <p id="pending-deposits-stat" class="text-4xl font-bold">0</p>
                    </div>
                    <div class="stat-card">
                        <i class="ph-bold ph-hourglass-medium text-4xl text-orange-500 mb-3"></i>
                        <p class="text-lg text-gray-500">Pending Withdrawals</p>
                        <p id="pending-withdrawals-stat" class="text-4xl font-bold">0</p>
                    </div>
                    <div class="stat-card">
                        <i class="ph-bold ph-money text-4xl text-green-500 mb-3"></i>
                        <p class="text-lg text-gray-500">Total Ad Earnings</p>
                        <p id="total-earnings-stat" class="text-4xl font-bold">৳0</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4">Recent Activity</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="p-3 font-semibold">User</th>
                                    <th class="p-3 font-semibold">Activity</th>
                                    <th class="p-3 font-semibold">Amount</th>
                                    <th class="p-3 font-semibold">Time</th>
                                </tr>
                            </thead>
                            <tbody id="recent-activity-body">
                                <tr><td colspan="4" class="text-center p-4 text-gray-500">Loading recent activity...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="users-page" class="page">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">User Management</h1>
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                        <input type="text" id="user-search" class="w-full md:w-1/2 p-3 border rounded-lg" placeholder="Search by name, email, or phone...">
                        <button id="export-users-btn" class="w-full md:w-auto bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700">Export Users</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="p-3 font-semibold">Username</th>
                                    <th class="p-3 font-semibold">Email</th>
                                    <th class="p-3 font-semibold">Phone</th>
                                    <th class="p-3 font-semibold">Balance</th>
                                    <th class="p-3 font-semibold">Ad Income</th>
                                    <th class="p-3 font-semibold">Current Plan</th>
                                    <th class="p-3 font-semibold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body">
                                <tr><td colspan="7" class="text-center p-4 text-gray-500">Loading users...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        
            <div id="deposits-page" class="page">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h1 class="text-3xl font-bold text-gray-800">Deposit Management</h1>
                    <button id="manual-deposit-btn" class="w-full md:w-auto bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-700">Add Deposit Manually</button>
                </div>

                <div class="mb-6 flex flex-wrap">
                    <button class="tab-button active" data-tab="pending-deposits-tab">Pending Deposits</button>
                    <button class="tab-button" data-tab="manual-deposits-tab">Manual Deposits</button>
                    <button class="tab-button" data-tab="completed-deposits-tab">Completed Deposits</button>
                </div>

                <div id="pending-deposits-tab" class="submenu active">
                    <div class="bg-white p-6 rounded-lg shadow mb-8">
                        <h2 class="text-xl font-bold mb-4">Pending Deposit Requests</h2>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead><tr class="bg-gray-100">
                                    <th class="p-3">User Email</th><th class="p-3">Amount</th><th class="p-3">Method</th>
                                    <th class="p-3">Sender No.</th><th class="p-3">TrxID</th><th class="p-3">Date</th><th class="p-3">Actions</th>
                                </tr></thead>
                                <tbody id="pending-deposits-table-body">
                                    <tr><td colspan="7" class="text-center p-4 text-gray-500">Loading pending deposits...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="manual-deposits-tab" class="submenu">
                    <div class="bg-white p-6 rounded-lg shadow mb-8">
                        <h2 class="text-xl font-bold mb-4">Manual Deposits</h2>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead><tr class="bg-gray-100">
                                    <th class="p-3">User Email</th><th class="p-3">Amount</th><th class="p-3">Method</th>
                                    <th class="p-3">Date</th><th class="p-3">Status</th><th class="p-3">Actions</th>
                                </tr></thead>
                                <tbody id="manual-deposits-table-body">
                                    <tr><td colspan="6" class="text-center p-4 text-gray-500">Loading manual deposits...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="completed-deposits-tab" class="submenu">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-bold mb-4">Completed Deposit History</h2>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead><tr class="bg-gray-100">
                                    <th class="p-3">User Email</th><th class="p-3">Amount</th><th class="p-3">Method</th>
                                    <th class="p-3">Date</th><th class="p-3">Status</th>
                                </tr></thead>
                                <tbody id="completed-deposits-table-body">
                                    <tr><td colspan="5" class="text-center p-4 text-gray-500">Loading completed deposits...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="withdrawals-page" class="page">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Withdrawal Management</h1>
                 <div class="bg-white p-6 rounded-lg shadow mb-8">
                    <h2 class="text-xl font-bold mb-4">Pending Withdrawal Requests</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                           <thead><tr class="bg-gray-100">
                                <th class="p-3">User Email</th><th class="p-3">Amount</th><th class="p-3">Method</th>
                                <th class="p-3">Receiver No.</th><th class="p-3">Actions</th>
                            </tr></thead>
                            <tbody id="pending-withdrawals-table-body">
                                <tr><td colspan="5" class="text-center p-4 text-gray-500">Loading pending withdrawals...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4">Completed Withdrawal History</h2>
                       <div class="overflow-x-auto">
                        <table class="w-full text-left">
                           <thead><tr class="bg-gray-100">
                                <th class="p-3">User Email</th><th class="p-3">Amount</th><th class="p-3">Method</th>
                                <th class="p-3">Date</th><th class="p-3">Status</th>
                            </tr></thead>
                            <tbody id="withdrawals-history-table-body">
                                <tr><td colspan="5" class="text-center p-4 text-gray-500">Loading withdrawal history...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="membership-applications-page" class="page">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Manual Plan Activations</h1>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4">Pending Plan Activation Requests</h2>
                    <p class="text-sm text-gray-500 mb-4">This section is for manual plan activations (e.g., user deposited funds and is now requesting a plan). User app purchases are automatic.</p>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead><tr class="bg-gray-100">
                                <th class="p-3">User</th><th class="p-3">Email</th><th class="p-3">Applied Plan</th>
                                <th class="p-3">Applied Date</th><th class="p-3">Payment Method</th><th class="p-3">Payment Details</th><th class="p-3">Actions</th>
                            </tr></thead>
                            <tbody id="membership-applications-table-body">
                                <tr><td colspan="7" class="text-center p-4 text-gray-500">Loading membership applications...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="plans-page" class="page">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h1 class="text-3xl font-bold text-gray-800">Membership Plans</h1>
                    <button id="add-plan-btn" class="w-full md:w-auto bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-700">Add New Plan</button>
                </div>
                 <div class="bg-white p-6 rounded-lg shadow">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead><tr class="bg-gray-100">
                                <th class="p-3">Plan Name</th><th class="p-3">Price</th><th class="p-3">Daily Ads</th>
                                <th class="p-3">Daily Income</th><th class="p-3">Validity (Days)</th><th class="p-3">Status</th><th class="p-3">Actions</th>
                            </tr></thead>
                            <tbody id="plans-table-body">
                                <tr><td colspan="7" class="text-center p-4 text-gray-500">Loading plans...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tasks-page" class="page">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h1 class="text-3xl font-bold text-gray-800">Task Management</h1>
                    <button id="add-task-btn" class="w-full md:w-auto bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-700">Add New Task</button>

                </div>
                <div class="bg-white p-6 rounded-lg shadow mb-8">
                    <h2 class="text-xl font-bold mb-4">Available Tasks</h2>
                       <div class="overflow-x-auto">
                        <table class="w-full text-left">
                           <thead><tr class="bg-gray-100">
                                <th class="p-3">Title</th><th class="p-3">Type</th><th class="p-3">Reward</th>
                                <th class="p-3">Timer (Sec)</th><th class="p-3">Assigned Plan</th><th class="p-3">Status</th><th class="p-3">Actions</th>
                            </tr></thead>
                            <tbody id="tasks-table-body">
                                <tr><td colspan="7" class="text-center p-4 text-gray-500">Loading tasks...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                 <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4">Pending Task Verifications</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead><tr class="bg-gray-100">
                                <th class="p-3">User</th><th class="p-3">Task</th><th class="p-3">Proof</th>
                                <th class="p-3">Date</th><th class="p-3">Actions</th>
                            </tr></thead>
                            <tbody id="pending-tasks-table-body">
                                <tr><td colspan="5" class="text-center p-4 text-gray-500">No pending task verifications</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="support-links-page" class="page">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h1 class="text-3xl font-bold text-gray-800">Support Links Management</h1>
                    <button id="add-support-link-btn" class="w-full md:w-auto bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-700">Add Support Link</button>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4">Support Links</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead><tr class="bg-gray-100">
                                <th class="p-3">Order</th>
                                <th class="p-3">Title</th>
                                <th class="p-3">URL</th>
                                <th class="p-3">Icon</th>
                                <th class="p-3">Status</th>
                                <th class="p-3">Actions</th>
                            </tr></thead>
                            <tbody id="support-links-table-body">
                                <tr><td colspan="6" class="text-center p-4 text-gray-500">Loading support links...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="appearance-page" class="page">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Appearance Customization</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-bold mb-4">Theme Colors</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-700 mb-2">Primary Color</label>
                                <div class="flex items-center gap-3">
                                    <input type="color" id="primary-color" class="color-picker" value="#0d9488">
                                    <input type="text" id="primary-color-text" class="form-input flex-1" value="#0d9488">
                                </div>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2">Secondary Color (Hover)</label>
                                <div class="flex items-center gap-3">
                                    <input type="color" id="secondary-color" class="color-picker" value="#059669">
                                    <input type="text" id="secondary-color-text" class="form-input flex-1" value="#059669">
                                </div>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2">Background Color</label>
                                <div class="flex items-center gap-3">
                                    <input type="color" id="background-color" class="color-picker" value="#f3f4f6">
                                    <input type="text" id="background-color-text" class="form-input flex-1" value="#f3f4f6">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-bold mb-4">App Settings</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-700 mb-2">App Name</label>
                                <input type="text" id="app-name" class="form-input w-full" value="Falco Cash">
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2">App Logo URL</label>
                                <input type="url" id="app-logo" class="form-input w-full" placeholder="https://example.com/logo.png">
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2">Default Task Timer (seconds)</label>
                                <input type="number" id="default-task-timer" class="form-input w-full" value="30" min="10" max="300">
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="maintenance-mode" class="mr-2">
                                <label for="maintenance-mode" class="text-gray-700">Maintenance Mode</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow mb-8">
                    <h2 class="text-xl font-bold mb-4">Homepage Customization</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-700 mb-2">Welcome Message</label>
                            <textarea id="welcome-message" class="form-input w-full h-24">Welcome to Falco Cash! Start earning today by completing simple tasks.</textarea>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 mb-2">Homepage YouTube Link (How-To Video)</label>
                            <input type="url" id="homepage-youtube-link" class="form-input w-full" placeholder="https://youtube.com/watch?v=...">
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 mb-2">Featured Banner Text</label>
                            <input type="text" id="banner-text" class="form-input w-full" value="Special Bonus Offer! Deposit Now">
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">Banner Background Color</label>
                            <div class="flex items-center gap-3">
                                <input type="color" id="banner-bg-color" class="color-picker" value="#dc2626">
                                <input type="text" id="banner-bg-color-text" class="form-input flex-1" value="#dc2626">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end">
                    <button id="save-appearance-btn" class="bg-teal-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-teal-700">Save Changes</button>
                </div>
            </div>
            
            <div id="slider-control-page" class="page">
                 <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h1 class="text-3xl font-bold text-gray-800">Homepage Slider Control</h1>
                    <button id="add-slider-btn" class="w-full md:w-auto bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-700">Add New Slider</button>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4">Active Sliders</h2>
                    <p class="text-sm text-gray-500 mb-4">Drag and drop sliders to re-order them.</p>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead><tr class="bg-gray-100">
                                <th class="p-3">Order</th>
                                <th class="p-3">Image</th>
                                <th class="p-3">Title</th>
                                <th class="p-3">Redirect URL</th>
                                <th class="p-3">Status</th>
                                <th class="p-3">Actions</th>
                            </tr></thead>
                            <tbody id="sliders-table-body">
                                <tr><td colspan="6" class="text-center p-4 text-gray-500">Loading sliders...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="notifications-page" class="page">
                 <h1 class="text-3xl font-bold text-gray-800 mb-6">Send Notifications</h1>
                 <div class="bg-white p-6 rounded-lg shadow mb-8">
                    <h2 class="text-xl font-bold mb-4">Send a Message to All Users</h2>
                    <p class="text-sm text-gray-500 mb-4">This message will appear in the notification section of every user's app.</p>
                    <form id="notification-form">
                        <input type="text" id="notification-title" class="w-full p-3 border rounded-lg mb-3" placeholder="Notification Title" required>
                        <textarea id="notification-message" class="w-full p-3 border rounded-lg h-32" placeholder="Enter your message here..." required></textarea>
                        <button type="submit" class="bg-teal-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-700 mt-4">Send Notification</button>
                    </form>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4">Notification History</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead><tr class="bg-gray-100">
                                <th class="p-3">Title</th><th class="p-3">Message</th><th class="p-3">Date</th>
                                <th class="p-3">Actions</th>
                            </tr></thead>
                            <tbody id="notification-history-body">
                                <tr><td colspan="4" class="text-center p-4 text-gray-500">Loading notification history...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="analytics-page" class="page">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Analytics</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="stat-card">
                        <i class="ph-bold ph-trend-up text-4xl text-purple-500 mb-3"></i>
                        <p class="text-lg text-gray-500">Total Deposit Revenue</p>
                        <p id="total-revenue-stat" class="text-4xl font-bold">৳0</p>
                    </div>
                    <div class="stat-card">
                        <i class="ph-bold ph-users-three text-4xl text-indigo-500 mb-3"></i>
                        <p class="text-lg text-gray-500">Total Users</p>
                        <p id="active-users-stat" class="text-4xl font-bold">0</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4">User Growth</h2>
                    <div id="user-growth-chart" class="h-64 flex items-center justify-center text-gray-500">
                        (Chart functionality to be added)
                    </div>
                </div>
            </div>

            <!-- NEW REFERRALS PAGE -->
            <div id="referrals-page" class="page">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Referral Management</h1>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4">Referral Summary</h2>
                    <p class="text-sm text-gray-500 mb-4">This table shows users who have successfully referred others.</p>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="p-3 font-semibold">Referrer Name</th>
                                    <th class="p-3 font-semibold">Referrer Email</th>
                                    <th class="p-3 font-semibold">Refer Code</th>
                                    <th class="p-3 font-semibold">Total Referred</th>
                                    <th class="p-3 font-semibold">Total Deposits from Refs</th>
                                    <th class="p-3 font-semibold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="referrals-table-body">
                                <tr><td colspan="6" class="text-center p-4 text-gray-500">Loading referral data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="settings-page" class="page">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Settings</h1>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div>
                        <div class="bg-white p-6 rounded-lg shadow mb-8">
                            <h2 class="text-xl font-bold mb-4">Admin Password</h2>
                            <form id="password-form" class="space-y-4">
                                <div id="password-feedback" class="text-red-500 font-semibold mb-4 hidden"></div>
                                <div>
                                    <label for="current-password" class="font-medium text-gray-600">Current Password</label>
                                    <input type="password" id="current-password" class="w-full mt-1 p-3 border rounded-lg" required>
                                </div>
                                <div>
                                    <label for="new-password" class="font-medium text-gray-600">New Password</label>
                                    <input type="password" id="new-password" class="w-full mt-1 p-3 border rounded-lg" required>
                                </div>
                                <div>
                                    <label for="confirm-password" class="font-medium text-gray-600">Confirm New Password</label>
                                    <input type="password" id="confirm-password" class="w-full mt-1 p-3 border rounded-lg" required>
                                </div>
                                <button type="submit" class="bg-teal-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-700">Change Password</button>
                            </form>
                        </div>
                    </div>

                    <div>
                        <div class="bg-white p-6 rounded-lg shadow mb-8">
                            <h2 class="text-xl font-bold mb-4">Payment Settings</h2>
                            <p class="text-sm text-gray-500 mb-4">These numbers will be shown to users when they make a deposit.</p>
                            <form id="payment-settings-form" class="space-y-4">
                                <div>
                                    <label for="setting-bkash-number" class="font-medium text-gray-600">Bkash Number (for deposits)</label>
                                    <input type="text" id="setting-bkash-number" class="w-full mt-1 p-3 border rounded-lg" placeholder="e.g., 01700000000">
                                </div>
                                <div>
                                    <label for="setting-nagad-number" class="font-medium text-gray-600">Nagad Number (for deposits)</label>
                                    <input type="text" id="setting-nagad-number" class="w-full mt-1 p-3 border rounded-lg" placeholder="e.g., 01800000000">
                                </div>
                                <button type="submit" class="bg-teal-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-700">Save Payment Settings</button>

                            </form>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow mb-8"> <h2 class="text-xl font-bold mb-4">Bonus & Referral Settings</h2>
                            <form id="bonus-settings-form" class="space-y-4">
                                <div>
                                    <label for="setting-registration-bonus" class="font-medium text-gray-600">Registration Bonus (BDT)</label>
                                    <input type="number" id="setting-registration-bonus" class="w-full mt-1 p-3 border rounded-lg" placeholder="e.g., 10" value="0" step="0.01">
                                    <p class="text-xs text-gray-500 mt-1">Amount a new user gets upon registering.</p>
                                </div>
                                <div>
                                    <label for="setting-referral-discount" class="font-medium text-gray-600">Referral Discount (on first plan, %)</label>
                                    <input type="number" id="setting-referral-discount" class="w-full mt-1 p-3 border rounded-lg" placeholder="e.g., 10" value="0" step="1">
                                    <p class="text-xs text-gray-500 mt-1">Discount a *new user* gets on their *first plan* if referred.</p>
                                </div>
                                <div>
                                    <label for="setting-referral-commission" class="font-medium text-gray-600">Referral Commission (on deposits, %)</label>
                                    <input type="number" id="setting-referral-commission" class="w-full mt-1 p-3 border rounded-lg" placeholder="e.g., 20" value="0" step="1">
                                    <p class="text-xs text-gray-500 mt-1">Commission the *referrer* gets when their referred user *deposits*.</p>
                                </div>
                                <button type="submit" class="bg-teal-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-700">Save Bonus Settings</button>
                            </form>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow">
                            <h2 class="text-xl font-bold mb-4">Transaction Limits</h2>
                            <form id="transaction-limits-form" class="space-y-4">
                                <div>
                                    <label for="setting-min-deposit" class="font-medium text-gray-600">Minimum Deposit (BDT)</label>
                                    <input type="number" id="setting-min-deposit" class="w-full mt-1 p-3 border rounded-lg" placeholder="e.g., 100" value="0" step="0.01">
                                </div>
                                <div>
                                    <label for="setting-max-deposit" class="font-medium text-gray-600">Maximum Deposit (BDT)</label>
                                    <input type="number" id="setting-max-deposit" class="w-full mt-1 p-3 border rounded-lg" placeholder="e.g., 10000" value="0" step="0.01">
                                </div>
                                <div>
                                    <label for="setting-min-withdraw" class="font-medium text-gray-600">Minimum Withdraw (BDT)</label>
                                    <input type="number" id="setting-min-withdraw" class="w-full mt-1 p-3 border rounded-lg" placeholder="e.g., 200" value="0" step="0.01">
                                </div>
                                <div>
                                    <label for="setting-max-withdraw" class="font-medium text-gray-600">Maximum Withdraw (BDT)</label>
                                    <input type="number" id="setting-max-withdraw" class="w-full mt-1 p-3 border rounded-lg" placeholder="e.g., 5000" value="0" step="0.01">
                                </div>
                                <button type="submit" class="bg-teal-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-700">Save Transaction Limits</button>
                            </form>
                        </div>
                        </div>
                </div>

            </div>

        </main>
    </div>

    <div id="modal" class="custom-modal-overlay">
        <div id="modal-content" class="custom-modal">
            </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, getDocs, onSnapshot, addDoc, setDoc, updateDoc, deleteDoc, writeBatch, serverTimestamp, query, where, orderBy, limit, runTransaction, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
  apiKey: "AIzaSyCkjp7IHZALzXLKwX_XYy-KwjUQM50OooU",
  authDomain: "falco-cash.firebaseapp.com",
  projectId: "falco-cash",
  storageBucket: "falco-cash.firebasestorage.app",
  messagingSenderId: "153837929521",
  appId: "1:153837929521:web:4374660705687a25c54110",
  measurementId: "G-PFBP8C1BHS"
};

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- ADMIN AUTH (SIMPLE PASSWORD) ---
        let ADMIN_PASSWORD = "3681206";

        // --- STATE & DOM ELEMENTS ---
        let allUsers = [];
        let allPlans = [];
        let allTasks = [];
        let allTransactions = [];
        let allMembershipApplications = [];
        let allSupportLinks = [];
        let allSliders = [];
        let processedReferralData = []; // NEW: For referral page
        let appSettings = {};
        const loginPage = document.getElementById('login-page');
        const adminPanel = document.getElementById('admin-panel');
        const pages = document.querySelectorAll('.page');
        const sidebarLinks = document.querySelectorAll('.sidebar-link');
        const modal = document.getElementById('modal');
        const modalContent = document.getElementById('modal-content');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');

        // --- UTILS ---
        const showModal = (html, showClose = true) => {
            modalContent.innerHTML = `${showClose ? '<button class="close-btn" onclick="window.hideModal()"> &times;</button>' : ''}${html}`;
            modal.classList.add('visible');
        };

        window.hideModal = () => {
            modal.classList.remove('visible');
        };

        const formatCurrency = (amount) => `৳${parseFloat(amount || 0).toFixed(2)}`;
        const formatDate = (timestamp) => {
             if (!timestamp) return 'N/A';
             try { return timestamp.toDate().toLocaleString(); } catch { return 'N/A'; }
        };

        // --- AUTHENTICATION ---
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const password = document.getElementById('login-password').value;

            if (password === ADMIN_PASSWORD) {
                loginPage.style.display = 'none';
                adminPanel.classList.remove('hidden');
                initializeAdminPanel();
            } else {
                showModal(`
                    <h2 class="text-xl font-bold text-red-600 mb-3">Login Failed</h2>
                    <p>Incorrect password. Please try again.</p>
                    <div class="mt-4 flex justify-end">
                        <button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">OK</button>
                    </div>
                `);
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            loginPage.style.display = 'flex';
            adminPanel.classList.add('hidden');
            document.getElementById('login-password').value = '';
        });

        // --- NAVIGATION ---
        sidebarLinks.forEach(link => {
            link.addEventListener('click', e => {
                e.preventDefault();
                const pageId = link.dataset.page;

                pages.forEach(p => p.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');

                sidebarLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');

                if (window.innerWidth < 768) {
                    sidebar.classList.add('-translate-x-full');
                    sidebarOverlay.classList.add('hidden');
                }
            });
        });

        // --- INITIALIZE APP DATA & LISTENERS ---
        function initializeAdminPanel() {
            const menuToggleBtn = document.getElementById('menu-toggle-btn');
            
            menuToggleBtn.addEventListener('click', () => {
                sidebar.classList.remove('-translate-x-full');
                sidebarOverlay.classList.remove('hidden');
            });

            sidebarOverlay.addEventListener('click', () => {
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('hidden');
            });

            // --- [FIX 2] GENERIC TAB SWITCHING LOGIC ---
            adminPanel.addEventListener('click', (e) => {
                const tabButton = e.target.closest('.tab-button');
                if (tabButton) {
                    e.preventDefault();
                    const tabId = tabButton.dataset.tab;
                    if (!tabId) return;

                    // Find parent container (the page) to scope the tab switching
                    const tabContainer = tabButton.closest('.page');
                    if (!tabContainer) return;

                    // Remove active class from all buttons in this group
                    tabContainer.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    // Add active class to clicked button
                    tabButton.classList.add('active');

                    // Hide all submenus in this group
                    tabContainer.querySelectorAll('.submenu').forEach(menu => menu.classList.remove('active'));
                    
                    // Show the target submenu
                    const targetSubmenu = tabContainer.querySelector(`#${tabId}`);
                    if (targetSubmenu) {
                        targetSubmenu.classList.add('active');
                    }
                }
            });

            loadDashboardStats();
            listenForUsers(); // This will now also trigger referral processing
            listenForTransactions(); // This will also trigger referral processing
            listenForPlans();
            listenForTasks();
            listenForSupportLinks();
            listenForSliders();
            listenForAppSettings();
            listenForNotifications();
            listenForMembershipApplications();

            document.getElementById('user-search').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredUsers = allUsers.filter(user =>
                    user.data.username?.toLowerCase().includes(searchTerm) ||
                    user.data.email?.toLowerCase().includes(searchTerm) ||
                    user.data.phone?.toLowerCase().includes(searchTerm)
                );
                renderUsersTable(filteredUsers);
            });

            document.getElementById('export-users-btn').addEventListener('click', () => {
                exportUsersToCSV();
            });

            // Admin Password Change Logic (Settings Page)
            document.getElementById('password-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const currentPassword = document.getElementById('current-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                const feedbackEl = document.getElementById('password-feedback');

                feedbackEl.classList.add('hidden');
                feedbackEl.classList.remove('text-red-500', 'text-green-500');

                if (currentPassword !== ADMIN_PASSWORD) {
                    feedbackEl.textContent = 'Current password is incorrect.';
                    feedbackEl.classList.remove('hidden');
                    feedbackEl.classList.add('text-red-500');
                    return;
                }
                if (newPassword !== confirmPassword) {
                    feedbackEl.textContent = 'New passwords do not match.';
                    feedbackEl.classList.remove('hidden');
                    feedbackEl.classList.add('text-red-500');
                    return;
                }
                if (newPassword.length < 6) {
                    feedbackEl.textContent = 'New password must be at least 6 characters.';
                    feedbackEl.classList.remove('hidden');
                    feedbackEl.classList.add('text-red-500');
                    return;
                }
                
                ADMIN_PASSWORD = newPassword;
                feedbackEl.textContent = 'Password changed successfully!';
                feedbackEl.classList.remove('hidden');
                feedbackEl.classList.add('text-green-500');
                e.target.reset();
            });

            document.getElementById('payment-settings-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const bkashNumber = document.getElementById('setting-bkash-number').value;
                const nagadNumber = document.getElementById('setting-nagad-number').value;
                try {
                    await setDoc(doc(db, "appSettings", "main"), {
                        paymentSettings: {
                            bkash: bkashNumber,
                            nagad: nagadNumber
                        },
                        updatedAt: serverTimestamp()
                    }, { merge: true });
                    showModal(`
                        <h2 class="text-xl font-bold text-teal-600 mb-3">Success</h2>
                        <p>Payment settings saved successfully!</p>
                        <div class="mt-4 flex justify-end"><button class="bg-teal-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-700" onclick="window.hideModal()">OK</button></div>
                    `);
                } catch (error) {
                    console.error("Error saving payment settings:", error);
                    showModal(`
                        <h2 class="text-xl font-bold text-red-600 mb-3">Error</h2>
                        <p>Error saving payment settings. Please try again.</p>
                        <div class="mt-4 flex justify-end"><button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">OK</button></div>
                    `);
                }
            });

            // NEW: Bonus Settings Form Listener (Corrected to merge nested object)
            document.getElementById('bonus-settings-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const registrationBonus = parseFloat(document.getElementById('setting-registration-bonus').value) || 0;
                const referralDiscount = parseFloat(document.getElementById('setting-referral-discount').value) || 0;
                const referralCommission = parseFloat(document.getElementById('setting-referral-commission').value) || 0;
                
                try {
                    // Corrected: Merge with existing nested settings
                    const existingAppSettings = appSettings.appSettings || {};
                    await setDoc(doc(db, "appSettings", "main"), {
                        appSettings: {
                            ...existingAppSettings, // Preserve existing
                            registrationBonus: registrationBonus, // Update/add
                            referrerPlanDiscountPercent: referralDiscount,
                            referralCommissionPercent: referralCommission
                        },
                        updatedAt: serverTimestamp()
                    }, { merge: true });

                    showModal(`
                        <h2 class="text-xl font-bold text-teal-600 mb-3">Success</h2>
                        <p>Bonus & Referral settings saved successfully!</p>
                        <div class="mt-4 flex justify-end"><button class="bg-teal-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-700" onclick="window.hideModal()">OK</button></div>
                    `);
                } catch (error) {
                    console.error("Error saving bonus settings:", error);
                    showModal(`
                        <h2 class="text-xl font-bold text-red-600 mb-3">Error</h2>
                        <p>Error saving bonus settings. Please try again.</p>
                        <div class="mt-4 flex justify-end"><button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">OK</button></div>
                    `);
                }
            });

            // NEW: Transaction Limits Form Listener
            document.getElementById('transaction-limits-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const minDeposit = parseFloat(document.getElementById('setting-min-deposit').value) || 0;
                const maxDeposit = parseFloat(document.getElementById('setting-max-deposit').value) || 0;
                const minWithdraw = parseFloat(document.getElementById('setting-min-withdraw').value) || 0;
                const maxWithdraw = parseFloat(document.getElementById('setting-max-withdraw').value) || 0;
                
                try {
                    // Merge with existing appSettings.appSettings
                    const existingAppSettings = appSettings.appSettings || {};
                    
                    await setDoc(doc(db, "appSettings", "main"), {
                        appSettings: {
                            ...existingAppSettings, // Preserve existing values
                            minDeposit: minDeposit, // Add/update new values
                            maxDeposit: maxDeposit,
                            minWithdraw: minWithdraw,
                            maxWithdraw: maxWithdraw
                        },
                        updatedAt: serverTimestamp()
                    }, { merge: true });

                    showModal(`
                        <h2 class="text-xl font-bold text-teal-600 mb-3">Success</h2>
                        <p>Transaction limits saved successfully!</p>
                        <div class="mt-4 flex justify-end"><button class="bg-teal-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-700" onclick="window.hideModal()">OK</button></div>
                    `);
                } catch (error) {
                    console.error("Error saving transaction limits:", error);
                    showModal(`
                        <h2 class="text-xl font-bold text-red-600 mb-3">Error</h2>
                        <p>Error saving transaction limits. Please try again.</p>
                        <div class="mt-4 flex justify-end"><button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">OK</button></div>
                    `);
                }
            });


            document.getElementById('manual-deposit-btn').addEventListener('click', () => {
                window.showManualDepositModal();
            });
            document.getElementById('add-plan-btn').addEventListener('click', () => {
                window.showAddPlanModal();
            });
            document.getElementById('add-task-btn').addEventListener('click', () => {
                window.showAddTaskModal();
            });
            document.getElementById('add-support-link-btn').addEventListener('click', () => {
                window.showAddSupportLinkModal();
            });
            // NEW: Add Slider Button
            document.getElementById('add-slider-btn').addEventListener('click', () => {
                window.showAddSliderModal();
            });
            document.getElementById('save-appearance-btn').addEventListener('click', () => {
                saveAppearanceSettings();
            });
            setupColorPickers();
            document.getElementById('notification-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const title = document.getElementById('notification-title').value;
                const message = document.getElementById('notification-message').value;
                try {
                    await addDoc(collection(db, "notifications"), {
                        title,
                        message,
                        timestamp: serverTimestamp()
                    });
                     showModal(`
                        <h2 class="text-xl font-bold text-teal-600 mb-3">Success</h2>
                        <p>Notification sent successfully!</p>
                        <div class="mt-4 flex justify-end"><button class="bg-teal-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-700" onclick="window.hideModal()">OK</button></div>
                    `);
                    e.target.reset();
                } catch (error) {
                    console.error("Error sending notification:", error);
                     showModal(`
                        <h2 class="text-xl font-bold text-red-600 mb-3">Error</h2>
                        <p>Error sending notification: ${error.message}</p>
                        <div class="mt-4 flex justify-end"><button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">OK</button></div>
                    `);
                }
            });
        }

        // --- DASHBOARD ---
        function loadDashboardStats() {
            onSnapshot(collection(db, "users"), (snapshot) => {
                document.getElementById('total-users-stat').textContent = snapshot.size;
                document.getElementById('active-users-stat').textContent = snapshot.size; // Using Total Users for Active Users stat placeholder
            });
            const pendingDepositsQuery = query(collection(db, "transactions"), where("type", "==", "deposit"), where("status", "==", "pending"));
            onSnapshot(pendingDepositsQuery, (snapshot) => {
                document.getElementById('pending-deposits-stat').textContent = snapshot.size;
            });
            const pendingWithdrawalsQuery = query(collection(db, "transactions"), where("type", "==", "withdraw"), where("status", "==", "pending"));
            onSnapshot(pendingWithdrawalsQuery, (snapshot) => {
                document.getElementById('pending-withdrawals-stat').textContent = snapshot.size;
            });
            const completedTasksQuery = query(collection(db, "transactions"), where("type", "==", "ad_income"), where("status", "==", "approved"));
            onSnapshot(completedTasksQuery, (snapshot) => {
                const totalEarnings = snapshot.docs.reduce((sum, doc) => sum + (doc.data().amount || 0), 0);
                document.getElementById('total-earnings-stat').textContent = formatCurrency(totalEarnings);
            });
            const totalRevenueQuery = query(collection(db, "transactions"), where("type", "==", "deposit"), where("status", "==", "approved"));
            onSnapshot(totalRevenueQuery, (snapshot) => {
                const totalRevenue = snapshot.docs.reduce((sum, doc) => sum + (doc.data().amount || 0), 0);
                document.getElementById('total-revenue-stat').textContent = formatCurrency(totalRevenue);
            });
            const recentActivityQuery = query(collection(db, "transactions"), orderBy("timestamp", "desc"), limit(10));
            onSnapshot(recentActivityQuery, (snapshot) => {
                const activities = snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
                // allTransactions will be set by the main transactions listener, but we can use this for a quick initial render
                renderRecentActivity(activities);
            });
        }

        function renderRecentActivity(activities) {
            const tableBody = document.getElementById('recent-activity-body');
            if (activities.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-gray-500">No recent activity.</td></tr>`;
                return;
            }
            tableBody.innerHTML = activities.map(activity => {
                const user = allUsers.find(u => u.id === activity.data.userId);
                const userName = user ? user.data.username : (activity.data.userEmail || 'Unknown User');
                let activityType = '';
                let amount = '';
                let status = activity.data.status;
                switch(activity.data.type) {
                    case 'deposit': activityType = `Deposit (${status})`; amount = `+${formatCurrency(activity.data.amount)}`; break;
                    case 'withdraw': activityType = `Withdrawal (${status})`; amount = `-${formatCurrency(activity.data.amount)}`; break;
                    case 'ad_income': activityType = `Ad Earning`; amount = `+${formatCurrency(activity.data.amount)}`; break;
                    case 'plan_purchase': activityType = `Plan Purchase`; amount = `-${formatCurrency(activity.data.amount)}`; break;
                    case 'referral_commission': activityType = `Referral Bonus`; amount = `+${formatCurrency(activity.data.amount)}`; break;
                    default: activityType = activity.data.type; amount = formatCurrency(activity.data.amount);
                }
                return `
                    <tr class="border-b">
                        <td class="p-3">${userName}</td>
                        <td class="p-3">${activityType}</td>
                        <td class="p-3">${amount}</td>
                        <td class="p-3">${formatDate(activity.data.timestamp)}</td>
                    </tr>
                `;
            }).join('');
        }

        // --- USERS ---
        function listenForUsers() {
            onSnapshot(collection(db, "users"), (snapshot) => {
                allUsers = snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
                renderUsersTable(allUsers);
                // Since the transaction listener might fire before user listener, re-render recent activity
                if (allTransactions.length > 0) {
                    renderRecentActivity(allTransactions.slice(0, 10));
                }
                // NEW: Process referral data
                processAndRenderReferrals();
            });
        }

        function renderUsersTable(users) {
            const tableBody = document.getElementById('users-table-body');
            if (users.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="7" class="text-center p-4 text-gray-500">No users found.</td></tr>`;
                return;
            }
            tableBody.innerHTML = users.map(user => {
                return `
                    <tr class="border-b">
                        <td class="p-3">${user.data.username || 'N/A'}</td>
                        <td class="p-3">${user.data.email || 'N/A'}</td>
                        <td class="p-3">${user.data.phone || 'N/A'}</td>
                        <td class="p-3">${formatCurrency(user.data.balance || 0)}</td>
                        <td class="p-3">${formatCurrency(user.data.adIncome || 0)}</td>
                        <td class="p-3">${user.data.activePlanName || 'None'}</td>
                        <td class="p-3">
                            <button class="bg-blue-500 text-white px-3 py-1 rounded mr-2" onclick="window.editUser('${user.id}')">Edit</button>
                            <button class="bg-red-500 text-white px-3 py-1 rounded" onclick="window.deleteUserConfirmation('${user.id}')">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        window.editUser = (userId) => {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;
            const modalHtml = `
                <h2 class="text-xl font-bold mb-4">Edit User: ${user.data.username || 'N/A'}</h2>
                <form id="edit-user-form">
                    <div class="mb-4"><label class="block text-gray-700 mb-2">Username</label><input type="text" id="edit-user-username" class="w-full p-3 border rounded-lg" value="${user.data.username || ''}" required></div>
                    <div class="mb-4"><label class="block text-gray-700 mb-2">Email</label><input type="email" id="edit-user-email" class="w-full p-3 border rounded-lg" value="${user.data.email || ''}" required></div>
                    <div class="mb-4"><label class="block text-gray-700 mb-2">Phone</label><input type="text" id="edit-user-phone" class="w-full p-3 border rounded-lg" value="${user.data.phone || ''}"></div>
                    <div class="mb-4"><label class="block text-gray-700 mb-2">Balance</label><input type="number" id="edit-user-balance" class="w-full p-3 border rounded-lg" value="${user.data.balance || 0}" step="0.01" required></div>
                    <div class="mb-4"><label class="block text-gray-700 mb-2">Current Plan</label><select id="edit-user-plan" class="w-full p-3 border rounded-lg"><option value="">No Plan</option>${allPlans.map(plan => `<option value="${plan.id}" ${user.data.activePlan === plan.id ? 'selected' : ''}>${plan.data.name}</option>`).join('')}</select></div>
                    <div class="flex justify-end gap-3"><button type="button" class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">Cancel</button><button type="submit" class="bg-teal-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-700">Update User</button></div>
                </form>`;
            showModal(modalHtml);
            document.getElementById('edit-user-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = document.getElementById('edit-user-username').value;
                const email = document.getElementById('edit-user-email').value;
                const phone = document.getElementById('edit-user-phone').value;
                const balance = parseFloat(document.getElementById('edit-user-balance').value);
                const selectedPlanId = document.getElementById('edit-user-plan').value;
                const plan = allPlans.find(p => p.id === selectedPlanId);
                try {
                    await updateDoc(doc(db, "users", userId), { 
                        username, email, phone, balance, 
                        activePlan: plan ? plan.id : null, 
                        activePlanName: plan ? plan.data.name : null,
                        updatedAt: serverTimestamp() 
                    });
                    showModal(`<h2 class="text-xl font-bold text-teal-600 mb-3">Success</h2><p>User updated successfully!</p><div class="mt-4 flex justify-end"><button class="bg-teal-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-700" onclick="window.hideModal()">OK</button></div>`);
                } catch (error) { 
                    console.error("Error updating user:", error); 
                    showModal(`<h2 class="text-xl font-bold text-red-600 mb-3">Error</h2><p>Error updating user: ${error.message}</p><div class="mt-4 flex justify-end"><button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">OK</button></div>`);
                }
            });
        };

        window.deleteUserConfirmation = (userId) => {
            showModal(`
                <h2 class="text-xl font-bold text-red-600 mb-3">Confirm Deletion</h2>
                <p>Are you sure you want to delete this user? This action cannot be undone.</p>
                <div class="mt-4 flex justify-end gap-3">
                    <button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">Cancel</button>
                    <button class="bg-red-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-red-700" onclick="window.deleteUser('${userId}')">Delete User</button>
                </div>
            `);
        };
        
        window.deleteUser = async (userId) => {
            window.hideModal(); // Close confirmation modal first
            try { 
                await deleteDoc(doc(db, "users", userId)); 
                showModal(`<h2 class="text-xl font-bold text-teal-600 mb-3">Success</h2><p>User deleted successfully!</p><div class="mt-4 flex justify-end"><button class="bg-teal-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-700" onclick="window.hideModal()">OK</button></div>`);
            } catch (error) { 
                console.error("Error deleting user:", error); 
                showModal(`<h2 class="text-xl font-bold text-red-600 mb-3">Error</h2><p>Error deleting user: ${error.message}</p><div class="mt-4 flex justify-end"><button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">OK</button></div>`);
            }
        };

        function exportUsersToCSV() {
            // Functionality remains the same, but uses a modal for feedback
            const headers = ['Username', 'Email', 'Phone', 'Balance', 'Ad Income', 'Refer Income', 'Current Plan', 'Registration Date'];
            const csvContent = [
                headers.join(','),
                ...allUsers.map(user => [
                    `"${user.data.username || ''}"`,
                    `"${user.data.email || ''}"`,
                    `"${user.data.phone || ''}"`,
                    user.data.balance || 0,
                    user.data.adIncome || 0,
                    user.data.referIncome || 0,
                    `"${user.data.activePlanName || 'None'}"`,
                    `"${user.data.accountCreateDate ? formatDate(user.data.accountCreateDate) : 'N/A'}"`
                ].join(','))
            ].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'users.csv';
            a.click();
            URL.revokeObjectURL(url);
             showModal(`<h2 class="text-xl font-bold text-teal-600 mb-3">Export Complete</h2><p>User data has been downloaded as users.csv.</p><div class="mt-4 flex justify-end"><button class="bg-teal-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-700" onclick="window.hideModal()">OK</button></div>`);
        }

        // --- TRANSACTIONS (DEPOSITS & WITHDRAWALS) ---
        function listenForTransactions() {
            const q = query(collection(db, "transactions"), orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                allTransactions = snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
                renderTransactions(allTransactions);
                renderRecentActivity(allTransactions.slice(0, 10));
                // NEW: Process referral data
                processAndRenderReferrals();
            });
        }

        function renderTransactions(transactions) {
            const pendingDeposits = transactions.filter(t => t.data.type === 'deposit' && t.data.status === 'pending');
            const manualDeposits = transactions.filter(t => t.data.type === 'deposit' && t.data.method?.startsWith('Manual'));
            const completedDeposits = transactions.filter(t => t.data.type === 'deposit' && t.data.status !== 'pending');
            const pendingWithdrawals = transactions.filter(t => t.data.type === 'withdraw' && t.data.status === 'pending');
            const completedWithdrawals = transactions.filter(t => t.data.type === 'withdraw' && t.data.status !== 'pending');
            renderPendingDeposits(pendingDeposits);
            renderManualDeposits(manualDeposits);
            renderCompletedDeposits(completedDeposits);
            renderPendingWithdrawals(pendingWithdrawals);
            renderCompletedWithdrawals(completedWithdrawals);
        }

        function renderPendingDeposits(deposits) {
            const tableBody = document.getElementById('pending-deposits-table-body');
            if (deposits.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="7" class="text-center p-4 text-gray-500">No pending deposits.</td></tr>`; return;
            }
            tableBody.innerHTML = deposits.map(tx => {
                const user = allUsers.find(u => u.id === tx.data.userId);
                return `
                <tr class="border-b">
                    <td class="p-3">${user?.data.email || tx.data.userEmail || 'N/A'}</td>
                    <td class="p-3">${formatCurrency(tx.data.amount)}</td>
                    <td class="p-3">${tx.data.method}</td>
                    <td class="p-3">${tx.data.senderNumber || 'N/A'}</td>
                    <td class="p-3">${tx.data.transactionId || 'N/A'}</td>
                    <td class="p-3">${formatDate(tx.data.timestamp)}</td>
                    <td class="p-3">
                        <button class="bg-green-500 text-white px-3 py-1 rounded mr-2" onclick="window.approveDepositConfirmation('${tx.id}', '${tx.data.userId}', ${tx.data.amount})">Approve</button>
                        <button class="bg-red-500 text-white px-3 py-1 rounded" onclick="window.rejectTransactionConfirmation('${tx.id}')">Reject</button>
                    </td>
                </tr>`}).join('');
        }

        function renderManualDeposits(deposits) {
            const tableBody = document.getElementById('manual-deposits-table-body');
            if (deposits.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-4 text-gray-500">No manual deposits recorded.</td></tr>`; return;
            }
            tableBody.innerHTML = deposits.map(tx => {
                const user = allUsers.find(u => u.id === tx.data.userId);
                return `
                <tr class="border-b">
                    <td class="p-3">${user?.data.email || tx.data.userEmail || 'N/A'}</td>
                    <td class="p-3">${formatCurrency(tx.data.amount)}</td>
                    <td class="p-3">${tx.data.method}</td>
                    <td class="p-3">${formatDate(tx.data.timestamp)}</td>
                    <td class="p-3">${tx.data.status}</td>
                    <td class="p-3">
                        <button class="bg-red-500 text-white px-3 py-1 rounded" onclick="window.deleteTransactionConfirmation('${tx.id}')">Delete</button>
                    </td>
                </tr>`}).join('');
        }

        function renderCompletedDeposits(deposits) {
            const tableBody = document.getElementById('completed-deposits-table-body');
            if (deposits.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-gray-500">No completed deposits.</td></tr>`; return;
            }
            tableBody.innerHTML = deposits.map(tx => {
                const user = allUsers.find(u => u.id === tx.data.userId);
                 return `
                <tr class="border-b">
                    <td class="p-3">${user?.data.email || tx.data.userEmail || 'N/A'}</td>
                    <td class="p-3">${formatCurrency(tx.data.amount)}</td>
                    <td class="p-3">${tx.data.method}</td>
                    <td class="p-3">${formatDate(tx.data.timestamp)}</td>
                    <td class="p-3">
                        <span class="px-2 py-1 rounded text-xs ${tx.data.status === 'approved' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${tx.data.status}
                        </span>
                    </td>
                </tr>`}).join('');
        }

        function renderPendingWithdrawals(withdrawals) {
            const tableBody = document.getElementById('pending-withdrawals-table-body');
            if (withdrawals.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-gray-500">No pending withdrawals.</td></tr>`; return;
            }
            tableBody.innerHTML = withdrawals.map(tx => {
                const user = allUsers.find(u => u.id === tx.data.userId);
                 return `
                <tr class="border-b">
                    <td class="p-3">${user?.data.email || tx.data.userEmail || 'N/A'}</td>
                    <td class="p-3">${formatCurrency(tx.data.amount)}</td>
                    <td class="p-3">${tx.data.method}</td>
                    <td class="p-3">${tx.data.receiverNumber || 'N/A'}</td>
                    <td class="p-3">
                        <button class="bg-green-500 text-white px-3 py-1 rounded mr-2" onclick="window.approveWithdrawalConfirmation('${tx.id}')">Approve</button>
                        <button class="bg-red-500 text-white px-3 py-1 rounded" onclick="window.rejectWithdrawalConfirmation('${tx.id}', '${tx.data.userId}', ${tx.data.amount})">Reject</button>
                    </td>
                </tr>`}).join('');
        }

        function renderCompletedWithdrawals(withdrawals) {
            const tableBody = document.getElementById('withdrawals-history-table-body');
            if (withdrawals.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-gray-500">No withdrawal history.</td></tr>`; return;
            }
            tableBody.innerHTML = withdrawals.map(tx => {
                const user = allUsers.find(u => u.id === tx.data.userId);
                 return `
                <tr class="border-b">
                    <td class="p-3">${user?.data.email || tx.data.userEmail || 'N/A'}</td>
                    <td class="p-3">${formatCurrency(tx.data.amount)}</td>
                    <td class="p-3">${tx.data.method}</td>
                    <td class="p-3">${formatDate(tx.data.timestamp)}</td>
                    <td class="p-3">
                        <span class="px-2 py-1 rounded text-xs ${tx.data.status === 'approved' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${tx.data.status}
                        </span>
                    </td>
                </tr>`}).join('');
        }
        
        // --- REFERRALS LOGIC (Verified - Shows ALL referred users in details) ---
        function processAndRenderReferrals() {
            // Wait until users are loaded
            if (allUsers.length === 0) {
                 // console.log("Referrals: Waiting for users to load."); // Optional: uncomment for debugging
                return; // Can't do anything without users
            }
             // console.log("Referrals: Processing..."); // Optional: uncomment for debugging
            
            // 1. Map total approved deposits for every user (if transactions are loaded)
            const depositsByUserId = {};
            if (allTransactions.length > 0) { // Check if transactions are available
                allTransactions.forEach(tx => {
                    if (tx.data.type === 'deposit' && tx.data.status === 'approved') {
                        const userId = tx.data.userId;
                        depositsByUserId[userId] = (depositsByUserId[userId] || 0) + tx.data.amount;
                    }
                });
            } else {
                 // console.log("Referrals: Transactions not loaded yet for deposit calculation."); // Optional
            }

            // 2. Map referred users to their referrer (CASE-INSENSITIVE)
            // Creates an object where keys are UPPERCASE refer codes,
            // and values are arrays of ALL user objects who used that code.
            const referralsByCode = {};
            allUsers.forEach(user => {
                const referCode = user.data.referredBy; // This is the code the NEW user used
                if (referCode) {
                    const upperCaseCode = referCode.toUpperCase(); // Standardize to uppercase
                    if (!referralsByCode[upperCaseCode]) {
                        referralsByCode[upperCaseCode] = [];
                    }
                    referralsByCode[upperCaseCode].push(user); // 'user' is the new user
                }
            });
             // console.log("Referrals: Mapped referred users:", Object.keys(referralsByCode).length); // Optional


            // 3. Process data for each user who *is* a referrer (CASE-INSENSITIVE)
            // Creates the data specifically for the main "Referral Summary" table.
            processedReferralData = [];
            allUsers.forEach(referrer => { // 'referrer' is the potential referrer
                const referCode = referrer.data.referCode; // This is the referrer's OWN code
                if (!referCode) return; // This user doesn't have a refer code, so skip them

                const upperCaseCode = referCode.toUpperCase(); // Standardize to uppercase
                // Get the array of ALL users referred by this referrer
                const referredUsers = referralsByCode[upperCaseCode] || []; // Look up their standardized code
                
                // --- IMPORTANT: Only add to the *main summary table* if they have referred at least one person ---
                if (referredUsers.length > 0) {
                    let totalDepositFromRefs = 0;
                    // Calculate total deposit from ALL referred users (if transactions are loaded)
                    if (allTransactions.length > 0) { 
                        referredUsers.forEach(referredUser => {
                            totalDepositFromRefs += (depositsByUserId[referredUser.id] || 0);
                        });
                    }
                    
                    // Store ALL relevant data for this referrer
                    processedReferralData.push({
                        referrerId: referrer.id,
                        referrer: referrer, // The user object of the referrer
                        referredUsers: referredUsers, // The FULL array of referred user objects (used by View Details)
                        totalReferred: referredUsers.length,
                        totalDepositFromRefs: totalDepositFromRefs 
                    });
                }
            });
             // console.log("Referrals: Processed referrer data for summary:", processedReferralData.length); // Optional


            // 4. Render the main summary table
            renderReferralsTable(processedReferralData);
        }

        // Renders the main "Referral Summary" table (only shows referrers)
        function renderReferralsTable(referralData) {
            const tableBody = document.getElementById('referrals-table-body');
             if (!tableBody) {
                 console.error("Referrals table body not found!");
                 return;
             }
            if (referralData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-4 text-gray-500">No users have referred anyone yet.</td></tr>`; return;
            }
            
            // Sort by total referred, descending
            referralData.sort((a, b) => b.totalReferred - a.totalReferred);
            
            tableBody.innerHTML = referralData.map(data => `
                <tr class="border-b">
                    <td class="p-3">${data.referrer.data.username || 'N/A'}</td>
                    <td class="p-3">${data.referrer.data.email || 'N/A'}</td>
                    <td class="p-3">${data.referrer.data.referCode || 'N/A'}</td>
                    <td class="p-3">${data.totalReferred}</td>
                    <td class="p-3">${formatCurrency(data.totalDepositFromRefs)}</td>
                    <td class="p-3">
                        <button class="bg-blue-500 text-white px-3 py-1 rounded" onclick="window.viewReferralDetails('${data.referrerId}')">View Details</button>
                    </td>
                </tr>`).join('');
             // console.log("Referrals: Summary Table rendered."); // Optional
        }
        
        // Shows the modal with the details for a SPECIFIC referrer
        window.viewReferralDetails = (referrerId) => {
            // Find the data object containing the FULL list of referred users for this referrer
            const data = processedReferralData.find(r => r.referrerId === referrerId);
            if (!data) {
                 console.error("Referral details not found for ID:", referrerId);
                return;
             }

            // 1. Re-calculate deposits for accuracy at the time of viewing
            const depositsByUserId = {};
            allTransactions.forEach(tx => {
                if (tx.data.type === 'deposit' && tx.data.status === 'approved') {
                    const userId = tx.data.userId;
                    depositsByUserId[userId] = (depositsByUserId[userId] || 0) + tx.data.amount;
                }
            });
            
            // --- IMPORTANT: Iterate through the FULL `data.referredUsers` array ---
            // This list is NOT filtered by deposit or plan status. It shows EVERYONE referred.
            const listHtml = data.referredUsers.map(user => {
                const totalDeposit = depositsByUserId[user.id] || 0;
                // Get registration date if available
                const regDate = user.data.accountCreateDate ? formatDate(user.data.accountCreateDate) : 'N/A';
                return `
                    <tr class="border-b">
                        <td class="p-2">${user.data.email || 'N/A'}</td>
                        <td class="p-2">${user.data.activePlanName || 'None'}</td>
                        <td class="p-2">${formatCurrency(totalDeposit)}</td>
                        <td class="p-2 text-sm">${regDate}</td> {/* Added Registration Date */}
                    </tr>
                `;
            }).join('');
            
            const modalHtml = `
                <h2 class="text-xl font-bold mb-4">Referrals by ${data.referrer.data.username}</h2>
                <p class="text-sm text-gray-600 mb-3">Total Referred: ${data.totalReferred}</p>
                <div class="overflow-y-auto" style="max-height: 60vh;">
                    <table class="w-full text-left text-sm"> {/* Adjusted font size */}
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="p-2">Referred User Email</th>
                                <th class="p-2">Current Plan</th>
                                <th class="p-2">Total Deposited</th>
                                <th class="p-2">Registration Date</th> {/* Added Header */}
                            </tr>
                        </thead>
                        {/* This tbody contains ALL referred users */}
                        <tbody>${listHtml || `<tr><td colspan="4" class="text-center p-3">No referred users found.</td></tr>`}</tbody>
                    </table>
                </div>
                <div class="mt-4 flex justify-end">
                    <button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">Close</button>
                </div>`;
            showModal(modalHtml);
        };
        // --- END REFERRALS LOGIC ---


        // --- MEMBERSHIP APPLICATIONS ---
        function listenForMembershipApplications() {
            const q = query(collection(db, "membershipApplications"), where("status", "==", "pending"));
            onSnapshot(q, (snapshot) => {
                allMembershipApplications = snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
                renderMembershipApplications(allMembershipApplications);
            });
        }

        function renderMembershipApplications(applications) {
            const tableBody = document.getElementById('membership-applications-table-body');
            if(applications.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="7" class="text-center p-4 text-gray-500">No pending membership applications.</td></tr>`; return;
            }
            tableBody.innerHTML = applications.map(app => {
                const user = allUsers.find(u => u.id === app.data.userId);
                const plan = allPlans.find(p => p.id === app.data.planId);
                return `
                    <tr class="border-b">
                        <td class="p-3">${user ? user.data.username : 'Unknown'}</td>
                        <td class="p-3">${user ? user.data.email : (app.data.userEmail || 'N/A')}</td>
                        <td class="p-3">${plan ? plan.data.name : 'Unknown Plan'} (${formatCurrency(plan?.data.price || 0)})</td>
                        <td class="p-3">${formatDate(app.data.timestamp)}</td>
                        <td class="p-3">${app.data.paymentMethod || 'N/A'}</td>
                        <td class="p-3">${app.data.paymentDetails || 'N/A'}</td>
                        <td class="p-3">
                            <button class="bg-green-500 text-white px-3 py-1 rounded mr-2" onclick="window.approveMembershipConfirmation('${app.id}', '${app.data.userId}', '${app.data.planId}')">Approve</button>
                            <button class="bg-red-500 text-white px-3 py-1 rounded" onclick="window.rejectMembershipConfirmation('${app.id}')">Reject</button>
                        </td>
                    </tr>`;
            }).join('');
        }

        // --- MEMBERSHIP PLANS ---
        function listenForPlans() {
            onSnapshot(collection(db, "plans"), (snapshot) => {
                allPlans = snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
                allPlans.sort((a, b) => (a.data.price || 0) - (b.data.price || 0));
                renderPlansTable(allPlans);
            });
        }

        function renderPlansTable(plans) {
            const tableBody = document.getElementById('plans-table-body');
            if (plans.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="7" class="text-center p-4 text-gray-500">No plans created yet.</td></tr>`; return;
            }
            tableBody.innerHTML = plans.map(plan => `
                <tr class="border-b">
                    <td class="p-3">${plan.data.name}</td>
                    <td class="p-3">${formatCurrency(plan.data.price)}</td>
                    <td class="p-3">${plan.data.dailyAds}</td>
                    <td class="p-3">${formatCurrency(plan.data.dailyIncome)}</td>
                    <td class="p-3">${plan.data.validity}</td>
                    <td class="p-3">
                        <span class="px-2 py-1 rounded text-xs ${plan.data.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${plan.data.active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td class="p-3">
                        <button class="bg-blue-500 text-white px-3 py-1 rounded mr-2" onclick="window.editPlan('${plan.id}')">Edit</button>
                        <button class="bg-red-500 text-white px-3 py-1 rounded" onclick="window.deletePlanConfirmation('${plan.id}')">Delete</button>
                    </td>
                </tr>`).join('');
        }

        // --- TASKS ---
        function listenForTasks() {
            onSnapshot(collection(db, "tasks"), (snapshot) => {
                allTasks = snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
                renderTasksTable(allTasks);
            });
            const verificationQuery = query(collection(db, "taskSubmissions"), where("status", "==", "pending"));
            onSnapshot(verificationQuery, (snapshot) => {
                 const submissions = snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
                 renderPendingTasks(submissions);
            });
        }

        function renderTasksTable(tasks) {
            const tableBody = document.getElementById('tasks-table-body');
            if (tasks.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="7" class="text-center p-4 text-gray-500">No tasks created yet.</td></tr>`; return;
            }
            tableBody.innerHTML = tasks.map(task => {
                const assignedPlan = allPlans.find(p => p.id === task.data.assignedPlanId);
                 return `
                <tr class="border-b">
                    <td class="p-3">${task.data.title}</td>
                    <td class="p-3">${task.data.type}</td>
                    <td class="p-3">${formatCurrency(task.data.reward)}</td>
                    <td class="p-3">${task.data.timerDuration || 'N/A'}</td>
                    <td class="p-3">${task.data.assignedPlanId === 'all' ? 'All Plans' : (assignedPlan?.data.name || 'Unknown Plan')}</td>
                    <td class="p-3">
                        <span class="px-2 py-1 rounded text-xs ${task.data.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${task.data.active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td class="p-3">
                        <button class="bg-blue-500 text-white px-3 py-1 rounded mr-2" onclick="window.editTask('${task.id}')">Edit</button>
                        <button class="bg-red-500 text-white px-3 py-1 rounded" onclick="window.deleteTaskConfirmation('${task.id}')">Delete</button>
                    </td>
                </tr>`}).join('');
        }

        function renderPendingTasks(submissions) {
            const tableBody = document.getElementById('pending-tasks-table-body');
            if (submissions.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-gray-500">No pending task verifications.</td></tr>`; return;
            }
            tableBody.innerHTML = submissions.map(sub => {
                const user = allUsers.find(u => u.id === sub.data.userId);
                const task = allTasks.find(t => t.id === sub.data.taskId);
                 return `
                    <tr class="border-b">
                        <td class="p-3">${user ? user.data.username : 'Unknown'}</td>
                        <td class="p-3">${task ? task.data.title : 'Unknown Task'}</td>
                        <td class="p-3">
                            ${sub.data.proof?.startsWith('http') ? `<a href="${sub.data.proof}" target="_blank" class="text-blue-500 hover:underline">View Proof</a>` : (sub.data.proof || 'N/A')}
                        </td>
                        <td class="p-3">${formatDate(sub.data.timestamp)}</td>
                        <td class="p-3">
                            <button class="bg-green-500 text-white px-3 py-1 rounded mr-2" onclick="window.approveTaskSubmissionConfirmation('${sub.id}', '${sub.data.userId}', ${task ? task.data.reward : 0})">Approve</button>
                            <button class="bg-red-500 text-white px-3 py-1 rounded" onclick="window.rejectTaskSubmissionConfirmation('${sub.id}')">Reject</button>
                        </td>
                    </tr>`;
            }).join('');
        }

        // --- SUPPORT LINKS ---
        function listenForSupportLinks() {
            const supportLinksQuery = query(collection(db, "supportLinks"), orderBy("order"));
            onSnapshot(supportLinksQuery, (snapshot) => {
                allSupportLinks = snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
                renderSupportLinksTable();
            });
        }

        function renderSupportLinksTable() {
            const tableBody = document.getElementById('support-links-table-body');
            if (allSupportLinks.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-4 text-gray-500">No support links created yet.</td></tr>`; return;
            }
            tableBody.innerHTML = allSupportLinks.map((link, index) => {
                return `
                    <tr class="border-b support-link-row" data-link-id="${link.id}" draggable="true">
                        <td class="p-3">
                            <div class="flex items-center gap-2">
                                <i class="ph ph-list drag-handle text-gray-400"></i>
                                <span>${link.data.order}</span>
                            </div>
                        </td>
                        <td class="p-3">${link.data.title || 'N/A'}</td>
                        <td class="p-3">
                            <a href="${link.data.url}" target="_blank" class="text-blue-500 hover:underline truncate block max-w-xs">${link.data.url}</a>
                        </td>
                        <td class="p-3">
                            <i class="${link.data.icon || 'ph ph-link'} text-xl"></i>
                        </td>
                        <td class="p-3">
                            <span class="px-2 py-1 rounded text-xs ${link.data.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${link.data.status || 'inactive'}
                            </span>
                        </td>
                        <td class="p-3">
                            <button class="bg-blue-500 text-white px-3 py-1 rounded mr-2" onclick="window.editSupportLink('${link.id}')">Edit</button>
                            <button class="bg-red-500 text-white px-3 py-1 rounded" onclick="window.deleteSupportLinkConfirmation('${link.id}')">Delete</button>
                        </td>
                    </tr>`;
            }).join('');
            initializeDragAndDrop("support-links-table-body", "support-link-row", updateLinkOrder);
        }
        
        // --- NEW: SLIDER CONTROL ---
        function listenForSliders() {
            const slidersQuery = query(collection(db, "homepageSliders"), orderBy("order"));
            onSnapshot(slidersQuery, (snapshot) => {
                allSliders = snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
                renderSlidersTable();
            });
        }

        function renderSlidersTable() {
            const tableBody = document.getElementById('sliders-table-body');
            if (allSliders.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-4 text-gray-500">No sliders created yet.</td></tr>`; return;
            }
            tableBody.innerHTML = allSliders.map((slider) => {
                return `
                    <tr class="border-b slider-row" data-slider-id="${slider.id}" draggable="true">
                        <td class="p-3">
                            <div class="flex items-center gap-2">
                                <i class="ph ph-list drag-handle text-gray-400"></i>
                                <span>${slider.data.order}</span>
                            </div>
                        </td>
                        <td class="p-3">
                            <img src="${slider.data.imageUrl}" alt="Slider Image" class="w-24 h-12 object-cover rounded-md">
                        </td>
                        <td class="p-3">${slider.data.title || 'N/A'}</td>
                        <td class="p-3">
                            <a href="${slider.data.linkUrl}" target="_blank" class="text-blue-500 hover:underline truncate block max-w-xs">${slider.data.linkUrl || 'N/A'}</a>
                        </td>
                        <td class="p-3">
                            <span class="px-2 py-1 rounded text-xs ${slider.data.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${slider.data.active ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td class="p-3">
                            <button class="bg-blue-500 text-white px-3 py-1 rounded mr-2" onclick="window.editSlider('${slider.id}')">Edit</button>
                            <button class="bg-red-500 text-white px-3 py-1 rounded" onclick="window.deleteSliderConfirmation('${slider.id}')">Delete</button>
                        </td>
                    </tr>`;
            }).join('');
            initializeDragAndDrop("sliders-table-body", "slider-row", updateSliderOrder);
        }

        // --- GENERALIZED DRAG & DROP ---
        function initializeDragAndDrop(tableBodyId, rowClass, updateFunction) {
            const tableBody = document.getElementById(tableBodyId);
            if (!tableBody) return;
            let draggedItem = null;
            
            const handleDragStart = (e) => {
                const row = e.target.closest(`tr.${rowClass}`);
                if (row) {
                    draggedItem = row;
                    e.dataTransfer.effectAllowed = 'move';
                    setTimeout(() => draggedItem.classList.add('dragging'), 0);
                }
            };
            
            const handleDragEnd = () => {
                if (draggedItem) {
                    draggedItem.classList.remove('dragging');
                    draggedItem = null;
                    updateFunction();
                }
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                if (!draggedItem) return;
                const afterElement = getDragAfterElement(tableBody, e.clientY, rowClass);
                if (afterElement == null) {
                    tableBody.appendChild(draggedItem);
                } else {
                    tableBody.insertBefore(draggedItem, afterElement);
                }
            };
            
            tableBody.removeEventListener('dragstart', tableBody.handleDragStart);
            tableBody.removeEventListener('dragend', tableBody.handleDragEnd);
            tableBody.removeEventListener('dragover', tableBody.handleDragOver);

            tableBody.handleDragStart = handleDragStart;
            tableBody.handleDragEnd = handleDragEnd;
            tableBody.handleDragOver = handleDragOver;
            
            tableBody.addEventListener('dragstart', tableBody.handleDragStart);
            tableBody.addEventListener('dragend', tableBody.handleDragEnd);
            tableBody.addEventListener('dragover', tableBody.handleDragOver);
        }

        function getDragAfterElement(container, y, rowClass) {
            const draggableElements = [...container.querySelectorAll(`.${rowClass}:not(.dragging)`)];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        async function updateLinkOrder() {
            const rows = document.querySelectorAll('#support-links-table-body .support-link-row');
            const batch = writeBatch(db);
            rows.forEach((row, index) => {
                const linkId = row.dataset.linkId;
                const docRef = doc(db, "supportLinks", linkId);
                row.querySelector('span').textContent = index + 1;
                batch.update(docRef, { order: index + 1 });
            });
            try {
                await batch.commit();
                showModal(`<h2 class="text-xl font-bold text-teal-600 mb-3">Success</h2><p>Link order saved successfully!</p><div class="mt-4 flex justify-end"><button class="bg-teal-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-700" onclick="window.hideModal()">OK</button></div>`);
            } catch (error) {
                console.error("Error updating link order:", error);
                showModal(`<h2 class="text-xl font-bold text-red-600 mb-3">Error</h2><p>Error saving link order: ${error.message}</p><div class="mt-4 flex justify-end"><button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">OK</button></div>`);
            }
        }
        
        async function updateSliderOrder() {
            const rows = document.querySelectorAll('#sliders-table-body .slider-row');
            const batch = writeBatch(db);
            rows.forEach((row, index) => {
                const sliderId = row.dataset.sliderId;
                const docRef = doc(db, "homepageSliders", sliderId);
                row.querySelector('span').textContent = index + 1;
                batch.update(docRef, { order: index + 1 });
            });
            try {
                await batch.commit();
                showModal(`<h2 class="text-xl font-bold text-teal-600 mb-3">Success</h2><p>Slider order saved successfully!</p><div class="mt-4 flex justify-end"><button class="bg-teal-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-700" onclick="window.hideModal()">OK</button></div>`);
            } catch (error) {
                console.error("Error updating slider order:", error);
                showModal(`<h2 class="text-xl font-bold text-red-600 mb-3">Error</h2><p>Error saving slider order: ${error.message}</p><div class="mt-4 flex justify-end"><button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">OK</button></div>`);
            }
        }

        // --- NOTIFICATIONS ---
        function listenForNotifications() {
            const q = query(collection(db, "notifications"), orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                const notifications = snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
                renderNotificationHistory(notifications);
            });
        }

        function renderNotificationHistory(notifications) {
            const tableBody = document.getElementById('notification-history-body');
            if (notifications.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-gray-500">No notifications sent yet.</td></tr>`; return;
            }
            tableBody.innerHTML = notifications.map(notif => `
                <tr class="border-b">
                    <td class="p-3">${notif.data.title}</td>
                    <td class="p-3">${notif.data.message}</td>
                    <td class="p-3">${formatDate(notif.data.timestamp)}</td>
                    <td class="p-3">
                        <button class="bg-red-500 text-white px-3 py-1 rounded" onclick="window.deleteNotificationConfirmation('${notif.id}')">Delete</button>
                    </td>
                </tr>`).join('');
        }

        // --- APPEARANCE SETTINGS ---
        function listenForAppSettings() {
            onSnapshot(doc(db, "appSettings", "main"), (doc) => {
                if (doc.exists()) {
                    appSettings = doc.data();
                    loadAppearanceSettings();
                } else {
                    setDoc(doc(db, "appSettings", "main"), { createdAt: serverTimestamp() });
                }
            });
        }

        function loadAppearanceSettings() {
            if (!appSettings) return;
            if (appSettings.themeColors) {
                document.getElementById('primary-color').value = appSettings.themeColors.primary || '#0d9488';
                document.getElementById('primary-color-text').value = appSettings.themeColors.primary || '#0d9488';
                document.getElementById('secondary-color').value = appSettings.themeColors.secondary || '#059669';
                document.getElementById('secondary-color-text').value = appSettings.themeColors.secondary || '#059669';
                document.getElementById('background-color').value = appSettings.themeColors.background || '#f3f4f6';
                document.getElementById('background-color-text').value = appSettings.themeColors.background || '#f3f4f6';
            }
            if (appSettings.appSettings) {
                document.getElementById('app-name').value = appSettings.appSettings.name || 'Falco Cash';
                document.getElementById('app-logo').value = appSettings.appSettings.logo || '';
                document.getElementById('default-task-timer').value = appSettings.appSettings.defaultTaskTimer || 30;
                document.getElementById('maintenance-mode').checked = appSettings.appSettings.maintenanceMode || false;
                
                // Load Bonus Settings
                document.getElementById('setting-registration-bonus').value = appSettings.appSettings.registrationBonus || 0;
                document.getElementById('setting-referral-discount').value = appSettings.appSettings.referrerPlanDiscountPercent || 0;
                document.getElementById('setting-referral-commission').value = appSettings.appSettings.referralCommissionPercent || 0;

                // Load Transaction Limits
                document.getElementById('setting-min-deposit').value = appSettings.appSettings.minDeposit || 0;
                document.getElementById('setting-max-deposit').value = appSettings.appSettings.maxDeposit || 0;
                document.getElementById('setting-min-withdraw').value = appSettings.appSettings.minWithdraw || 0;
                document.getElementById('setting-max-withdraw').value = appSettings.appSettings.maxWithdraw || 0;
            }
            if (appSettings.homepage) {
                document.getElementById('welcome-message').value = appSettings.homepage.welcomeMessage || '';
                document.getElementById('homepage-youtube-link').value = appSettings.homepage.youtubeLink || '';
                document.getElementById('banner-text').value = appSettings.homepage.bannerText || '';
                document.getElementById('banner-bg-color').value = appSettings.homepage.bannerBgColor || '#dc2626';
                document.getElementById('banner-bg-color-text').value = appSettings.homepage.bannerBgColor || '#dc2626';
            }
            if (appSettings.paymentSettings) {
                document.getElementById('setting-bkash-number').value = appSettings.paymentSettings.bkash || '';
                document.getElementById('setting-nagad-number').value = appSettings.paymentSettings.nagad || '';
            }
        }

        function setupColorPickers() {
            const colorInputs = [
                { picker: 'primary-color', text: 'primary-color-text' },
                { picker: 'secondary-color', text: 'secondary-color-text' },
                { picker: 'background-color', text: 'background-color-text' },
                { picker: 'banner-bg-color', text: 'banner-bg-color-text' }
            ];
            colorInputs.forEach(({ picker, text }) => {
                const pickerEl = document.getElementById(picker);
                const textEl = document.getElementById(text);
                if (pickerEl && textEl) {
                    // Two-way binding
                    pickerEl.addEventListener('input', () => { textEl.value = pickerEl.value; });
                    textEl.addEventListener('input', () => { if (/^#[0-9A-F]{6}$/i.test(textEl.value)) { pickerEl.value = textEl.value; } });
                }
            });
        }

        async function saveAppearanceSettings() {
            const themeColors = {
                primary: document.getElementById('primary-color').value,
                secondary: document.getElementById('secondary-color').value,
                background: document.getElementById('background-color').value
            };
            const appSettingsData = {
                name: document.getElementById('app-name').value,
                logo: document.getElementById('app-logo').value,
                defaultTaskTimer: parseInt(document.getElementById('default-task-timer').value),
                maintenanceMode: document.getElementById('maintenance-mode').checked
            };
            const homepageSettings = {
                welcomeMessage: document.getElementById('welcome-message').value,
                youtubeLink: document.getElementById('homepage-youtube-link').value,
                bannerText: document.getElementById('banner-text').value,
                bannerBgColor: document.getElementById('banner-bg-color').value
            };
            try {
                // Merge with existing appSettings data, not just overwrite
                await setDoc(doc(db, "appSettings", "main"), {
                    themeColors,
                    appSettings: {
                        ...appSettings.appSettings, // Preserve bonus & transaction settings
                        ...appSettingsData // Overwrite with new appearance settings
                    },
                    homepage: homepageSettings,
                    updatedAt: serverTimestamp()
                }, { merge: true });
                 showModal(`<h2 class="text-xl font-bold text-teal-600 mb-3">Success</h2><p>Appearance settings saved successfully!</p><div class="mt-4 flex justify-end"><button class="bg-teal-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-700" onclick="window.hideModal()">OK</button></div>`);
            } catch (error) {
                console.error("Error saving appearance settings:", error);
                showModal(`<h2 class="text-xl font-bold text-red-600 mb-3">Error</h2><p>Error saving appearance settings: ${error.message}</p><div class="mt-4 flex justify-end"><button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">OK</button></div>`);
            }
        }

        // --- ACTION FUNCTIONS (MODALS, APPROVE, REJECT, ETC.) ---

        // Deposit Actions
        window.approveDepositConfirmation = (txId, userId, amount) => {
            showModal(`
                <h2 class="text-xl font-bold text-teal-600 mb-3">Confirm Approval</h2>
                <p>Approve deposit of <strong>${formatCurrency(amount)}</strong>? This will credit the user's balance.</p>
                <p class="text-sm text-yellow-700 bg-yellow-100 p-2 rounded-md mt-2">Note: Referral commissions on deposits will be automatically applied if configured.</p>
                <div class="mt-4 flex justify-end gap-3">
                    <button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">Cancel</button>
                    <button class="bg-green-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-green-700" onclick="window.approveDeposit('${txId}', '${userId}', ${amount})">Approve</button>
                </div>
            `);
        };
        window.approveDeposit = async (txId, userId, amount) => {
            window.hideModal();
            try {
                const batch = writeBatch(db);
                batch.update(doc(db, "transactions", txId), { status: 'approved', approvedAt: serverTimestamp() });
                batch.update(doc(db, "users", userId), { balance: increment(amount) });
                
                // --- FIXED REFERRAL COMMISSION LOGIC (CASE-INSENSITIVE) ---
                const commissionPercent = appSettings.appSettings?.referralCommissionPercent || 0;
                const user = allUsers.find(u => u.id === userId);
                
                if (commissionPercent > 0 && user?.data.referredBy) {
                    // Make matching case-insensitive
                    const referredByCode = user.data.referredBy.toUpperCase();
                    const referrer = allUsers.find(u => u.data.referCode?.toUpperCase() === referredByCode);

                    if (referrer) {
                        const commissionAmount = (amount * commissionPercent) / 100;
                        
                        // 1. Add balance to referrer
                        batch.update(doc(db, "users", referrer.id), { 
                            balance: increment(commissionAmount),
                            referIncome: increment(commissionAmount)
                        });
                        
                        // 2. Log transaction for referrer
                        batch.set(doc(collection(db, "transactions")), {
                            userId: referrer.id,
                            userEmail: referrer.data.email, // Add email for clarity
                            type: 'referral_commission',
                            amount: commissionAmount,
                            details: `Commission from ${user.data.email}'s deposit`,
                            status: 'approved',
                            timestamp: serverTimestamp()
                        });
                    } else {
                         console.warn(`Referrer not found for code: ${referredByCode} (from user ${user.data.email})`);
                    }
                }
                // --- END FIXED LOGIC ---

                await batch.commit();
                showModal(`<h2 class="text-xl font-bold text-teal-600 mb-3">Success</h2><p>Deposit approved and balance credited. Referral commission (if any) also processed.</p><div class="mt-4 flex justify-end"><button class="bg-teal-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-700" onclick="window.hideModal()">OK</button></div>`);
            } catch (error) { 
                console.error("Error approving deposit:", error); 
                showModal(`<h2 class="text-xl font-bold text-red-600 mb-3">Error</h2><p>Error approving deposit: ${error.message}</p><div class="mt-4 flex justify-end"><button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">OK</button></div>`);
            }
        };

        window.rejectTransactionConfirmation = (txId) => {
            showModal(`
                <h2 class="text-xl font-bold text-red-600 mb-3">Confirm Rejection</h2>
                <p>Are you sure you want to reject this deposit request?</p>
                <div class="mt-4 flex justify-end gap-3">
                    <button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">Cancel</button>
                    <button class="bg-red-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-red-700" onclick="window.rejectTransaction('${txId}')">Reject</button>
                </div>
            `);
        };
        window.rejectTransaction = async (txId) => {
             window.hideModal();
             try { 
                 await updateDoc(doc(db, "transactions", txId), { status: 'rejected', rejectedAt: serverTimestamp() }); 
                 showModal(`<h2 class="text-xl font-bold text-teal-600 mb-3">Success</h2><p>Transaction marked as rejected.</p><div class="mt-4 flex justify-end"><button class="bg-teal-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-700" onclick="window.hideModal()">OK</button></div>`);
             } catch (error) { 
                 console.error("Error rejecting transaction:", error); 
                 showModal(`<h2 class="text-xl font-bold text-red-600 mb-3">Error</h2><p>Error rejecting transaction: ${error.message}</p><div class="mt-4 flex justify-end"><button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">OK</button></div>`);
             }
        };

        window.deleteTransactionConfirmation = (txId) => {
            showModal(`
                <h2 class="text-xl font-bold text-red-600 mb-3">Confirm Deletion</h2>
                <p>Are you sure you want to delete this transaction record? This only deletes the record, it does not affect user balance.</p>
                <div class="mt-4 flex justify-end gap-3">
                    <button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">Cancel</button>
                    <button class="bg-red-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-red-700" onclick="window.deleteTransaction('${txId}')">Delete Record</button>
                </div>
            `);
        };
        window.deleteTransaction = async (txId) => {
             window.hideModal();
             try { 
                 await deleteDoc(doc(db, "transactions", txId)); 
                 showModal(`<h2 class="text-xl font-bold text-teal-600 mb-3">Success</h2><p>Transaction record deleted.</p><div class="mt-4 flex justify-end"><button class="bg-teal-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-700" onclick="window.hideModal()">OK</button></div>`);
             } catch (error) { 
                 console.error("Error deleting transaction:", error); 
                 showModal(`<h2 class="text-xl font-bold text-red-600 mb-3">Error</h2><p>Error deleting transaction record: ${error.message}</p><div class="mt-4 flex justify-end"><button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">OK</button></div>`);
             }
        };


        // Withdrawal Actions
        window.approveWithdrawalConfirmation = (txId) => {
            showModal(`
                <h2 class="text-xl font-bold text-teal-600 mb-3">Confirm Payment</h2>
                <p>Have you manually paid the user? This will mark the request as approved.</p>
                <div class="mt-4 flex justify-end gap-3">
                    <button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">Cancel</button>
                    <button class="bg-green-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-green-700" onclick="window.approveWithdrawal('${txId}')">Paid & Approve</button>
                </div>
            `);
        };
        window.approveWithdrawal = async (txId) => {
             window.hideModal();
             try { 
                 await updateDoc(doc(db, "transactions", txId), { status: 'approved', approvedAt: serverTimestamp() }); 
                 showModal(`<h2 class="text-xl font-bold text-teal-600 mb-3">Success</h2><p>Withdrawal marked as approved.</p><div class="mt-4 flex justify-end"><button class="bg-teal-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-700" onclick="window.hideModal()">OK</button></div>`);
             } catch (error) { 
                 console.error("Error approving withdrawal:", error); 
                 showModal(`<h2 class="text-xl font-bold text-red-600 mb-3">Error</h2><p>Error approving withdrawal: ${error.message}</p><div class="mt-4 flex justify-end"><button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">OK</button></div>`);
             }
        };

        window.rejectWithdrawalConfirmation = (txId, userId, amount) => {
            showModal(`
                <h2 class="text-xl font-bold text-red-600 mb-3">Confirm Rejection & Refund</h2>
                <p>Reject this withdrawal? Funds (${formatCurrency(amount)}) will be returned to the user's balance.</p>
                <div class="mt-4 flex justify-end gap-3">
                    <button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">Cancel</button>
                    <button class="bg-red-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-red-700" onclick="window.rejectWithdrawal('${txId}', '${userId}', ${amount})">Reject & Refund</button>
                </div>
            `);
        };
        window.rejectWithdrawal = async (txId, userId, amount) => {
             window.hideModal();
             try {
                 const batch = writeBatch(db);
                 batch.update(doc(db, "transactions", txId), { status: 'rejected', rejectedAt: serverTimestamp() });
                 batch.update(doc(db, "users", userId), { balance: increment(amount) });
                 await batch.commit();
                 showModal(`<h2 class="text-xl font-bold text-teal-600 mb-3">Success</h2><p>Withdrawal rejected and funds returned to user balance.</p><div class="mt-4 flex justify-end"><button class="bg-teal-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-700" onclick="window.hideModal()">OK</button></div>`);
             } catch (error) { 
                 console.error("Error rejecting withdrawal:", error); 
                 showModal(`<h2 class="text-xl font-bold text-red-600 mb-3">Error</h2><p>Error rejecting withdrawal: ${error.message}</p><div class="mt-4 flex justify-end"><button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">OK</button></div>`);
             }
        };

        // Manual Deposit
        window.showManualDepositModal = () => {
             const modalHtml = `
                <h2 class="text-xl font-bold mb-4">Add Manual Deposit</h2>
                <form id="manual-deposit-form">
                    <div class="mb-4"><label class="block text-gray-700 mb-2">User Email</label><input type="email" id="manual-deposit-email" class="w-full p-3 border rounded-lg" required list="user-emails" placeholder="user@example.com"><datalist id="user-emails">${allUsers.map(u => `<option value="${u.data.email}">`).join('')}</datalist></div>
                    <div class="mb-4"><label class="block text-gray-700 mb-2">Amount (৳)</label><input type="number" id="manual-deposit-amount" class="w-full p-3 border rounded-lg" step="0.01" required placeholder="e.g., 500"></div>
                    <div class="mb-4"><label class="block text-gray-700 mb-2">Method/Reason</label><input type="text" id="manual-deposit-method" class="w-full p-3 border rounded-lg" value="Manual Bonus" required></div>
                    <div class="flex justify-end gap-3"><button type="button" class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">Cancel</button><button type="submit" class="bg-teal-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-700">Add Deposit</button></div>
                </form>`;
             showModal(modalHtml);
             document.getElementById('manual-deposit-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('manual-deposit-email').value;
                const amount = parseFloat(document.getElementById('manual-deposit-amount').value);
                const method = document.getElementById('manual-deposit-method').value;
                const user = allUsers.find(u => u.data.email === email);
                if (!user) { 
                    showModal(`<h2 class="text-xl font-bold text-red-600 mb-3">Error</h2><p>User not found with that email: ${email}</p><div class="mt-4 flex justify-end"><button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">OK</button></div>`);
                    return; 
                }
                if (isNaN(amount) || amount <= 0) { showModal(`<h2 class="text-xl font-bold text-red-600 mb-3">Error</h2><p>Invalid amount specified.</p><div class="mt-4 flex justify-end"><button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">OK</button></div>`); return; }
                 try {
                     const batch = writeBatch(db);
                     batch.set(doc(collection(db, "transactions")), { userId: user.id, userEmail: email, type: 'deposit', status: 'approved', method: `Manual: ${method}`, amount: amount, timestamp: serverTimestamp(), approvedAt: serverTimestamp() });
                     batch.update(doc(db, "users", user.id), { balance: increment(amount) });
                     await batch.commit();
                     showModal(`<h2 class="text-xl font-bold text-teal-600 mb-3">Success</h2><p>Manual deposit added and user balance updated.</p><div class="mt-4 flex justify-end"><button class="bg-teal-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-700" onclick="window.hideModal()">OK</button></div>`);
                 } catch (error) { 
                    console.error("Error adding manual deposit:", error); 
                    showModal(`<h2 class="text-xl font-bold text-red-600 mb-3">Error</h2><p>Error adding manual deposit: ${error.message}</p><div class="mt-4 flex justify-end"><button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">OK</button></div>`);
                 }
             });
        };

        // Membership Actions
         window.approveMembershipConfirmation = (appId, userId, planId) => {
             const plan = allPlans.find(p => p.id === planId);
             showModal(`
                <h2 class="text-xl font-bold text-teal-600 mb-3">Confirm Activation</h2>
                <p>Approve and activate membership for plan "<strong>${plan?.data.name || 'Unknown Plan'}</strong>" for this user?</p>
                <div class="mt-4 flex justify-end gap-3">
                    <button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">Cancel</button>
                    <button class="bg-green-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-green-700" onclick="window.approveMembership('${appId}', '${userId}', '${planId}')">Approve</button>
                </div>
            `);
         };
         window.approveMembership = async (appId, userId, planId) => {
             window.hideModal();
             const plan = allPlans.find(p => p.id === planId);
             if (!plan) { showModal(`<h2 class="text-xl font-bold text-red-600 mb-3">Error</h2><p>Plan details not found!</p><div class="mt-4 flex justify-end"><button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">OK</button></div>`); return; }
             try {
                 const batch = writeBatch(db);
                 batch.update(doc(db, "membershipApplications", appId), { status: 'approved', approvedAt: serverTimestamp() });
                 batch.update(doc(db, "users", userId), { activePlan: planId, activePlanName: plan.data.name, planActivationDate: serverTimestamp(), planValidity: plan.data.validity, tasksCompletedToday: 0, lastTaskReset: serverTimestamp() });
                 await batch.commit();
                 showModal(`<h2 class="text-xl font-bold text-teal-600 mb-3">Success</h2><p>Membership approved and user plan activated.</p><div class="mt-4 flex justify-end"><button class="bg-teal-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-700" onclick="window.hideModal()">OK</button></div>`);
             } catch (error) { 
                console.error("Error approving membership:", error); 
                showModal(`<h2 class="text-xl font-bold text-red-600 mb-3">Error</h2><p>Error approving membership: ${error.message}</p><div class="mt-4 flex justify-end"><button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">OK</button></div>`);
             }
         };

         window.rejectMembershipConfirmation = (appId) => {
             showModal(`
                <h2 class="text-xl font-bold text-red-600 mb-3">Confirm Rejection</h2>
                <p>Reject this membership application?</p>
                <div class="mt-4 flex justify-end gap-3">
                    <button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">Cancel</button>
                    <button class="bg-red-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-red-700" onclick="window.rejectMembership('${appId}')">Reject Application</button>
                </div>
            `);
         };
         window.rejectMembership = async (appId) => {
             window.hideModal();
             try { 
                 await updateDoc(doc(db, "membershipApplications", appId), { status: 'rejected', rejectedAt: serverTimestamp() }); 
                 showModal(`<h2 class="text-xl font-bold text-teal-600 mb-3">Success</h2><p>Membership application rejected.</p><div class="mt-4 flex justify-end"><button class="bg-teal-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-700" onclick="window.hideModal()">OK</button></div>`);
             } catch (error) { 
                console.error("Error rejecting membership:", error); 
                showModal(`<h2 class="text-xl font-bold text-red-600 mb-3">Error</h2><p>Error rejecting membership: ${error.message}</p><div class="mt-4 flex justify-end"><button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">OK</button></div>`);
             }
         };

        // Plan Actions
        window.editPlan = (planId) => { window.showAddPlanModal(planId); };
        window.deletePlanConfirmation = (planId) => {
             showModal(`
                <h2 class="text-xl font-bold text-red-600 mb-3">Confirm Deletion</h2>
                <p>Are you sure you want to delete this plan? This will NOT affect current users on this plan.</p>
                <div class="mt-4 flex justify-end gap-3">
                    <button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">Cancel</button>
                    <button class="bg-red-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-red-700" onclick="window.deletePlan('${planId}')">Delete Plan</button>
                </div>
            `);
        };
        window.deletePlan = async (planId) => {
             window.hideModal();
             try { 
                 await deleteDoc(doc(db, "plans", planId)); 
                 showModal(`<h2 class="text-xl font-bold text-teal-600 mb-3">Success</h2><p>Plan deleted successfully!</p><div class="mt-4 flex justify-end"><button class="bg-teal-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-700" onclick="window.hideModal()">OK</button></div>`);
             } catch (error) { 
                console.error("Error deleting plan:", error); 
                showModal(`<h2 class="text-xl font-bold text-red-600 mb-3">Error</h2><p>Error deleting plan: ${error.message}</p><div class="mt-4 flex justify-end"><button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">OK</button></div>`);
             }
        };

        window.showAddPlanModal = (planId = null) => {
            const isEdit = planId !== null;
            const plan = isEdit ? allPlans.find(p => p.id === planId) : null;
            const modalHtml = `
                <h2 class="text-xl font-bold mb-4">${isEdit ? 'Edit' : 'Add New'} Plan</h2>
                <form id="plan-form">
                    <div class="mb-4"><label class="block text-gray-700 mb-2">Plan Name</label><input type="text" id="plan-name" class="w-full p-3 border rounded-lg" value="${plan?.data.name || ''}" required></div>
                    <div class="mb-4"><label class="block text-gray-700 mb-2">Price (৳)</label><input type="number" id="plan-price" class="w-full p-3 border rounded-lg" value="${plan?.data.price || 0}" required></div>
                    <div class="mb-4"><label class="block text-gray-700 mb-2">Daily Ads</label><input type="number" id="plan-daily-ads" class="w-full p-3 border rounded-lg" value="${plan?.data.dailyAds || 1}" required></div>
                    <div class="mb-4"><label class="block text-gray-700 mb-2">Daily Income (৳)</label><input type="number" id="plan-daily-income" class="w-full p-3 border rounded-lg" value="${plan?.data.dailyIncome || 0}" step="0.01" required></div>
                    <div class="mb-4"><label class="block text-gray-700 mb-2">Validity (Days)</label><input type="number" id="plan-validity" class="w-full p-3 border rounded-lg" value="${plan?.data.validity || 30}" required></div>
                    <div class="mb-4"><label class="block text-gray-700 mb-2">Status</label><select id="plan-status" class="w-full p-3 border rounded-lg" required><option value="true" ${plan?.data.active ? 'selected' : ''}>Active</option><option value="false" ${!plan?.data.active ? 'selected' : ''}>Inactive</option></select></div>
                    <div class="flex justify-end gap-3"><button type="button" class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">Cancel</button><button type="submit" class="bg-teal-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-700">${isEdit ? 'Update' : 'Add'} Plan</button></div>
                </form>`;
            showModal(modalHtml);
            document.getElementById('plan-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const planData = { 
                    name: document.getElementById('plan-name').value, 
                    price: parseFloat(document.getElementById('plan-price').value), 
                    dailyAds: parseInt(document.getElementById('plan-daily-ads').value), 
                    dailyIncome: parseFloat(document.getElementById('plan-daily-income').value), 
                    validity: parseInt(document.getElementById('plan-validity').value), 
                    active: document.getElementById('plan-status').value === 'true', 
                    updatedAt: serverTimestamp() 
                };
                try {
                    if (isEdit) { await updateDoc(doc(db, "plans", planId), planData); } 
                    else { planData.createdAt = serverTimestamp(); await addDoc(collection(db, "plans"), planData); }
                    showModal(`<h2 class="text-xl font-bold text-teal-600 mb-3">Success</h2><p>Plan ${isEdit ? 'updated' : 'added'} successfully!</p><div class="mt-4 flex justify-end"><button class="bg-teal-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-700" onclick="window.hideModal()">OK</button></div>`);
                } catch (error) { 
                    console.error(`Error ${isEdit ? 'updating' : 'adding'} plan:`, error); 
                    showModal(`<h2 class="text-xl font-bold text-red-600 mb-3">Error</h2><p>Error ${isEdit ? 'updating' : 'adding'} plan: ${error.message}</p><div class="mt-4 flex justify-end"><button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">OK</button></div>`);
                }
            });
        };
        
        // Task Actions
        window.editTask = (taskId) => { window.showAddTaskModal(taskId); };
        window.deleteTaskConfirmation = (taskId) => {
             showModal(`
                <h2 class="text-xl font-bold text-red-600 mb-3">Confirm Deletion</h2>
                <p>Are you sure you want to delete this task?</p>
                <div class="mt-4 flex justify-end gap-3">
                    <button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">Cancel</button>
                    <button class="bg-red-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-red-700" onclick="window.deleteTask('${taskId}')">Delete Task</button>
                </div>
            `);
        };
        window.deleteTask = async (taskId) => {
             window.hideModal();
             try { 
                 await deleteDoc(doc(db, "tasks", taskId)); 
                 showModal(`<h2 class="text-xl font-bold text-teal-600 mb-3">Success</h2><p>Task deleted successfully!</p><div class="mt-4 flex justify-end"><button class="bg-teal-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-700" onclick="window.hideModal()">OK</button></div>`);
             } catch (error) { 
                 console.error("Error deleting task:", error); 
                 showModal(`<h2 class="text-xl font-bold text-red-600 mb-3">Error</h2><p>Error deleting task: ${error.message}</p><div class="mt-4 flex justify-end"><button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">OK</button></div>`);
             }
        };

        window.showAddTaskModal = (taskId = null) => {
            const isEdit = taskId !== null;
            const task = isEdit ? allTasks.find(t => t.id === taskId) : null;
            
            // --- MODIFIED HTML ---
            const modalHtml = `
                <h2 class="text-xl font-bold mb-4">${isEdit ? 'Edit' : 'Add New'} Task</h2>
                <form id="task-form">
                    <div class="mb-4"><label class="block text-gray-700 mb-2">Title</label><input type="text" id="task-title" class="w-full p-3 border rounded-lg" value="${task?.data.title || ''}" required></div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">Type</label>
                        <input type="text" id="task-type" list="task-types-list" class="w-full p-3 border rounded-lg" value="${task?.data.type || ''}" required placeholder="e.g., youtube, website, custom-task">
                        <datalist id="task-types-list">
                            <option value="youtube">YouTube</option>
                            <option value="telegram">Telegram</option>
                            <option value="website">Website Visit</option>
                            <option value="video">Video Watch</option>
                            </datalist>
                    </div>
                    <div class="mb-4"><label class="block text-gray-700 mb-2">Link/URL</label><input type="url" id="task-link" class="w-full p-3 border rounded-lg" value="${task?.data.link || ''}" placeholder="https://" required></div>
                    <div class="mb-4"><label class="block text-gray-700 mb-2">Reward (৳)</label><input type="number" id="task-reward" class="w-full p-3 border rounded-lg" value="${task?.data.reward || 0}" step="0.01" required></div>
                    <div class="mb-4"><label class="block text-gray-700 mb-2">Timer Duration (seconds)</label><input type="number" id="task-timer" class="w-full p-3 border rounded-lg" value="${task?.data.timerDuration || 30}" min="5" placeholder="e.g., 30"><p class="text-sm text-gray-500 mt-1">Leave blank or 0 to use default timer.</p></div>
                    <div class="mb-4"><label class="block text-gray-700 mb-2">Assign to Plan</label><select id="task-plan" class="w-full p-3 border rounded-lg"><option value="all">All Active Plans</option>${allPlans.map(plan => `<option value="${plan.id}" ${task?.data.assignedPlanId === plan.id ? 'selected' : ''}>${plan.data.name}</option>`).join('')}</select></div>
                    <div class="mb-4"><label class="block text-gray-700 mb-2">Status</label><select id="task-status" class="w-full p-3 border rounded-lg" required><option value="true" ${!isEdit || task?.data.active ? 'selected' : ''}>Active</option><option value="false" ${isEdit && !task?.data.active ? 'selected' : ''}>Inactive</option></select></div>
                    <div class="flex justify-end gap-3"><button type="button" class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">Cancel</button><button type="submit" class="bg-teal-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-700">${isEdit ? 'Update' : 'Add'} Task</button></div>
                </form>`;
            // --- END MODIFIED HTML ---
                
            showModal(modalHtml);
            
            document.getElementById('task-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const taskData = { 
                    title: document.getElementById('task-title').value, 
                    type: document.getElementById('task-type').value, // Reads value from the input field
                    link: document.getElementById('task-link').value, 
                    reward: parseFloat(document.getElementById('task-reward').value), 
                    timerDuration: parseInt(document.getElementById('task-timer').value) || 0, 
                    assignedPlanId: document.getElementById('task-plan').value, 
                    active: document.getElementById('task-status').value === 'true', 
                    updatedAt: serverTimestamp() 
                };
                if (!taskData.title || !taskData.link || !taskData.type || isNaN(taskData.reward)) { // Added check for type
                    showModal(`<h2 class="text-xl font-bold text-red-600 mb-3">Error</h2><p>Please fill all required fields correctly (Title, Type, Link, Reward).</p><div class="mt-4 flex justify-end"><button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">OK</button></div>`);
                    return; 
                }
                try {
                    if (isEdit) { await updateDoc(doc(db, "tasks", taskId), taskData); } 
                    else { taskData.createdAt = serverTimestamp(); await addDoc(collection(db, "tasks"), taskData); }
                    showModal(`<h2 class="text-xl font-bold text-teal-600 mb-3">Success</h2><p>Task ${isEdit ? 'updated' : 'added'} successfully!</p><div class="mt-4 flex justify-end"><button class="bg-teal-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-700" onclick="window.hideModal()">OK</button></div>`);
                } catch (error) { 
                    console.error(`Error ${isEdit ? 'updating' : 'adding'} task:`, error); 
                    showModal(`<h2 class="text-xl font-bold text-red-600 mb-3">Error</h2><p>Error ${isEdit ? 'updating' : 'adding'} task: ${error.message}</p><div class="mt-4 flex justify-end"><button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">OK</button></div>`);
                }
            });
        };

        // Task Submission Actions
         window.approveTaskSubmissionConfirmation = (submissionId, userId, reward) => {
            showModal(`
                <h2 class="text-xl font-bold text-teal-600 mb-3">Confirm Approval</h2>
                <p>Approve this task submission? Reward of <strong>${formatCurrency(reward)}</strong> will be credited to the user.</p>
                <div class="mt-4 flex justify-end gap-3">
                    <button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">Cancel</button>
                    <button class="bg-green-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-green-700" onclick="window.approveTaskSubmission('${submissionId}', '${userId}', ${reward})">Approve</button>
                </div>
            `);
         };
         window.approveTaskSubmission = async (submissionId, userId, reward) => {
            window.hideModal();
            try {
                const batch = writeBatch(db);
                batch.update(doc(db, "taskSubmissions", submissionId), { status: 'approved', approvedAt: serverTimestamp() });
                batch.update(doc(db, "users", userId), { balance: increment(reward), adIncome: increment(reward) });
                await batch.commit();
                showModal(`<h2 class="text-xl font-bold text-teal-600 mb-3">Success</h2><p>Task approved and reward credited.</p><div class="mt-4 flex justify-end"><button class="bg-teal-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-700" onclick="window.hideModal()">OK</button></div>`);
            } catch (error) { 
                console.error("Error approving task:", error); 
                showModal(`<h2 class="text-xl font-bold text-red-600 mb-3">Error</h2><p>Error approving task: ${error.message}</p><div class="mt-4 flex justify-end"><button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">OK</button></div>`);
            }
         };

         window.rejectTaskSubmissionConfirmation = (submissionId) => {
             showModal(`
                <h2 class="text-xl font-bold text-red-600 mb-3">Confirm Rejection</h2>
                <p>Reject this task submission? No reward will be credited.</p>
                <div class="mt-4 flex justify-end gap-3">
                    <button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">Cancel</button>
                    <button class="bg-red-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-red-700" onclick="window.rejectTaskSubmission('${submissionId}')">Reject</button>
                </div>
            `);
         };
         window.rejectTaskSubmission = async (submissionId) => {
             window.hideModal();
             try { 
                 await updateDoc(doc(db, "taskSubmissions", submissionId), { status: 'rejected', rejectedAt: serverTimestamp() }); 
                 showModal(`<h2 class="text-xl font-bold text-teal-600 mb-3">Success</h2><p>Task submission rejected.</p><div class="mt-4 flex justify-end"><button class="bg-teal-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-700" onclick="window.hideModal()">OK</button></div>`);
             } catch (error) { 
                 console.error("Error rejecting task:", error); 
                 showModal(`<h2 class="text-xl font-bold text-red-600 mb-3">Error</h2><p>Error rejecting task: ${error.message}</p><div class="mt-4 flex justify-end"><button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">OK</button></div>`);
             }
         };
         
        // Support Link Actions
        window.editSupportLink = (linkId) => { window.showAddSupportLinkModal(linkId); };
        window.deleteSupportLinkConfirmation = (linkId) => {
             showModal(`
                <h2 class="text-xl font-bold text-red-600 mb-3">Confirm Deletion</h2>
                <p>Are you sure you want to delete this support link?</p>
                <div class="mt-4 flex justify-end gap-3">
                    <button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">Cancel</button>
                    <button class="bg-red-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-red-700" onclick="window.deleteSupportLink('${linkId}')">Delete Link</button>
                </div>
            `);
        };
        window.deleteSupportLink = async (linkId) => {
            window.hideModal();
            try { 
                await deleteDoc(doc(db, "supportLinks", linkId)); 
                showModal(`<h2 class="text-xl font-bold text-teal-600 mb-3">Success</h2><p>Support link deleted successfully!</p><div class="mt-4 flex justify-end"><button class="bg-teal-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-700" onclick="window.hideModal()">OK</button></div>`);
            } catch (error) { 
                console.error("Error deleting support link:", error); 
                showModal(`<h2 class="text-xl font-bold text-red-600 mb-3">Error</h2><p>Error deleting support link: ${error.message}</p><div class="mt-4 flex justify-end"><button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">OK</button></div>`);
            }
        };
        
        // NEW: Slider Actions
        window.editSlider = (sliderId) => { window.showAddSliderModal(sliderId); };
        window.deleteSliderConfirmation = (sliderId) => {
             showModal(`
                <h2 class="text-xl font-bold text-red-600 mb-3">Confirm Deletion</h2>
                <p>Are you sure you want to delete this slider?</p>
                <div class="mt-4 flex justify-end gap-3">
                    <button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">Cancel</button>
                    <button class="bg-red-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-red-700" onclick="window.deleteSlider('${sliderId}')">Delete Slider</button>
                </div>
            `);
        };
        window.deleteSlider = async (sliderId) => {
            window.hideModal();
            try { 
                await deleteDoc(doc(db, "homepageSliders", sliderId)); 
                showModal(`<h2 class="text-xl font-bold text-teal-600 mb-3">Success</h2><p>Slider deleted successfully!</p><div class="mt-4 flex justify-end"><button class="bg-teal-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-700" onclick="window.hideModal()">OK</button></div>`);
            } catch (error) { 
                console.error("Error deleting slider:", error); 
                showModal(`<h2 class="text-xl font-bold text-red-600 mb-3">Error</h2><p>Error deleting slider: ${error.message}</p><div class="mt-4 flex justify-end"><button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">OK</button></div>`);
            }
        };
        
        window.showAddSliderModal = (sliderId = null) => {
            const isEdit = sliderId !== null;
            const slider = isEdit ? allSliders.find(s => s.id === sliderId) : null;
            const modalHtml = `
                <h2 class="text-xl font-bold mb-4">${isEdit ? 'Edit' : 'Add New'} Slider</h2>
                <form id="slider-form">
                    <div class="mb-4"><label class="block text-gray-700 mb-2">Title</label><input type="text" id="slider-title" class="w-full p-3 border rounded-lg" placeholder="e.g., Special Offer" value="${slider?.data.title || ''}" required></div>
                    <div class="mb-4"><label class="block text-gray-700 mb-2">Image URL</label><input type="url" id="slider-image-url" class="w-full p-3 border rounded-lg" placeholder="https://example.com/image.png" value="${slider?.data.imageUrl || ''}" required></div>
                    <div class="mb-4"><label class="block text-gray-700 mb-2">Redirect URL (Optional)</label><input type="url" id="slider-link-url" class="w-full p-3 border rounded-lg" placeholder="https://example.com/offer" value="${slider?.data.linkUrl || ''}"></div>
                    <div class="mb-4"><label class="block text-gray-700 mb-2">Order</label><input type="number" id="slider-order" class="w-full p-3 border rounded-lg" placeholder="Display order" value="${slider?.data.order || allSliders.length + 1}" required></div>
                    <div class="mb-4"><label class="block text-gray-700 mb-2">Status</label>
                        <select id="slider-status" class="w-full p-3 border rounded-lg" required>
                            <option value="true" ${!isEdit || slider?.data.active ? 'selected' : ''}>Active</option>
                            <option value="false" ${isEdit && !slider?.data.active ? 'selected' : ''}>Inactive</option>
                        </select>
                    </div>
                    <div class="flex justify-end gap-3"><button type="button" class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">Cancel</button><button type="submit" class="bg-teal-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-700">${isEdit ? 'Update' : 'Add'} Slider</button></div>
                </form>`;
            showModal(modalHtml);
            document.getElementById('slider-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const sliderData = {
                    title: document.getElementById('slider-title').value,
                    imageUrl: document.getElementById('slider-image-url').value,
                    linkUrl: document.getElementById('slider-link-url').value || null,
                    order: parseInt(document.getElementById('slider-order').value),
                    active: document.getElementById('slider-status').value === 'true',
                    updatedAt: serverTimestamp()
                };
                
                if (!sliderData.title || !sliderData.imageUrl || isNaN(sliderData.order)) { 
                    showModal(`<h2 class="text-xl font-bold text-red-600 mb-3">Error</h2><p>Please fill Title, Image URL, and Order fields.</p><div class="mt-4 flex justify-end"><button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">OK</button></div>`);
                    return; 
                }
                
                try {
                    if (isEdit) { 
                        await updateDoc(doc(db, "homepageSliders", sliderId), sliderData); 
                    } else { 
                        sliderData.createdAt = serverTimestamp();
                        await addDoc(collection(db, "homepageSliders"), sliderData); 
                    }
                    showModal(`<h2 class="text-xl font-bold text-teal-600 mb-3">Success</h2><p>Slider ${isEdit ? 'updated' : 'added'} successfully!</p><div class="mt-4 flex justify-end"><button class="bg-teal-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-700" onclick="window.hideModal()">OK</button></div>`);
                } catch (error) { 
                    console.error(`Error ${isEdit ? 'updating' : 'adding'} slider:`, error); 
                    showModal(`<h2 class="text-xl font-bold text-red-600 mb-3">Error</h2><p>Error ${isEdit ? 'updating' : 'adding'} slider: ${error.message}</p><div class="mt-4 flex justify-end"><button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">OK</button></div>`);
                }
            });
        };
        
        // Notification Actions
        window.deleteNotificationConfirmation = (notificationId) => {
             showModal(`
                <h2 class="text-xl font-bold text-red-600 mb-3">Confirm Deletion</h2>
                <p>Are you sure you want to delete this notification history?</p>
                <div class="mt-4 flex justify-end gap-3">
                    <button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">Cancel</button>
                    <button class="bg-red-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-red-700" onclick="window.deleteNotification('${notificationId}')">Delete History</button>
                </div>
            `);
        };
        window.deleteNotification = async (notificationId) => {
             window.hideModal();
             try { 
                 await deleteDoc(doc(db, "notifications", notificationId)); 
                 showModal(`<h2 class="text-xl font-bold text-teal-600 mb-3">Success</h2><p>Notification deleted.</p><div class="mt-4 flex justify-end"><button class="bg-teal-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-700" onclick="window.hideModal()">OK</button></div>`);
             } catch (error) { 
                 console.error("Error deleting notification:", error); 
                 showModal(`<h2 class="text-xl font-bold text-red-600 mb-3">Error</h2><p>Error deleting notification: ${error.message}</p><div class="mt-4 flex justify-end"><button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">OK</button></div>`);
             }
        };

        window.showAddSupportLinkModal = (linkId = null) => {
            const isEdit = linkId !== null;
            const link = isEdit ? allSupportLinks.find(l => l.id === linkId) : null;
            const modalHtml = `
                <h2 class="text-xl font-bold mb-4">${isEdit ? 'Edit' : 'Add New'} Support Link</h2>
                <form id="support-link-form">
                    <div class="mb-4"><label class="block text-gray-700 mb-2">Title</label><input type="text" id="support-link-title" class="w-full p-3 border rounded-lg" placeholder="Enter link title" value="${link?.data.title || ''}" required></div>
                    <div class="mb-4"><label class="block text-gray-700 mb-2">URL</label><input type="url" id="support-link-url" class="w-full p-3 border rounded-lg" placeholder="https://example.com" value="${link?.data.url || ''}" required></div>
                    <div class="mb-4"><label class="block text-gray-700 mb-2">Icon (Phosphor Icon Class)</label><input type="text" id="support-link-icon" class="w-full p-3 border rounded-lg" placeholder="ph ph-telegram-logo" value="${link?.data.icon || ''}"><p class="text-sm text-gray-500 mt-1">Use classes like "ph ph-telegram-logo", "ph ph-whatsapp-logo".</P></div>
                    <div class="mb-4"><label class="block text-gray-700 mb-2">Order</label><input type="number" id="support-link-order" class="w-full p-3 border rounded-lg" placeholder="Display order" value="${link?.data.order || allSupportLinks.length + 1}" required></div>
                    <div class="mb-4"><label class="block text-gray-700 mb-2">Status</label><select id="support-link-status" class="w-full p-3 border rounded-lg" required><option value="active" ${link?.data.status === 'active' ? 'selected' : ''}>Active</option><option value="inactive" ${link?.data.status === 'inactive' ? 'selected' : ''}>Inactive</option></select></div>
                    <div class="flex justify-end gap-3"><button type="button" class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">Cancel</button><button type="submit" class="bg-teal-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-700">${isEdit ? 'Update' : 'Add'} Link</button></div>
                </form>`;
            showModal(modalHtml);
            document.getElementById('support-link-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const title = document.getElementById('support-link-title').value;
                const url = document.getElementById('support-link-url').value;
                const icon = document.getElementById('support-link-icon').value;
                const order = parseInt(document.getElementById('support-link-order').value);
                const status = document.getElementById('support-link-status').value;
                if (!title || !url || isNaN(order)) { 
                    showModal(`<h2 class="text-xl font-bold text-red-600 mb-3">Error</h2><p>Please fill all required fields correctly.</p><div class="mt-4 flex justify-end"><button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">OK</button></div>`);
                    return; 
                }
                try {
                    const linkData = { title, url, icon: icon || 'ph ph-link', order, status, createdAt: isEdit ? (link.data.createdAt || serverTimestamp()) : serverTimestamp(), updatedAt: serverTimestamp() };
                    if (isEdit) { await updateDoc(doc(db, "supportLinks", linkId), linkData); } else { await addDoc(collection(db, "supportLinks"), linkData); }
                    showModal(`<h2 class="text-xl font-bold text-teal-600 mb-3">Success</h2><p>Support link ${isEdit ? 'updated' : 'added'} successfully!</p><div class="mt-4 flex justify-end"><button class="bg-teal-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-700" onclick="window.hideModal()">OK</button></div>`);
                } catch (error) { 
                    console.error(`Error ${isEdit ? 'updating' : 'adding'} support link:`, error); 
                    showModal(`<h2 class="text-xl font-bold text-red-600 mb-3">Error</h2><p>Error ${isEdit ? 'updating' : 'adding'} support link: ${error.message}</p><div class="mt-4 flex justify-end"><button class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600" onclick="window.hideModal()">OK</button></div>`);
                }
            });
        }

        const init = () => {
            console.log("Admin Panel Initializing...");
        };
        init();
    </script>
</body>
</html>

